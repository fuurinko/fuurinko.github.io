
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2021-10-27T03:21:25.650Z" itemprop="datePublished">
          2021-10-27
      </time>
    
    
    | 
    <a href='/tags/gdb/'>gdb</a>
    
    
</span>
                <h1>gdb附加调试的一些黑魔法</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script>
    <div id="aplayer-qwWebfut" class="aplayer aplayer-tag-marker meting-tag-marker"
         data-id="7342554262" data-server="netease" data-type="playlist" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#555"
    ></div> 

<h2 id="1）abstract"><a href="#1）abstract" class="headerlink" title="1）abstract"></a>1）abstract</h2><p>​    这个part主要综合了一些奇怪的调试中遇到的问题，不定期更新。</p>
<h2 id="2）格式化字符串-cctf-pwn3"><a href="#2）格式化字符串-cctf-pwn3" class="headerlink" title="2）格式化字符串-cctf-pwn3"></a>2）格式化字符串-cctf-pwn3</h2><h3 id="1）pause（p）导致ERROR-Could-not-find-ELF-base"><a href="#1）pause（p）导致ERROR-Could-not-find-ELF-base" class="headerlink" title="1）pause（p）导致ERROR: Could not find ELF base"></a>1）pause（p）导致ERROR: Could not find ELF base</h3><h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><p>​    在开始动调这个exp的时候，发现一个很奇怪的点就是如果下的断点的模式gdb.attach(sh)，那么程序会异常退出，大概是这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Attaching to program: /home/rin/pwn/ctf-wiki/format/cctf-pwn3/pwn3, process 27837</span><br><span class="line">Reading symbols from /lib/i386-linux-gnu/libc.so.6...Reading symbols from /usr/lib/debug//lib/i386-linux-gnu/libc-2.27.so...done.</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /lib/ld-linux.so.2...Reading symbols from /usr/lib/debug//lib/i386-linux-gnu/ld-2.27.so...done.</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line">Cannot access memory at address 0xf7fad924</span><br><span class="line"></span><br><span class="line">warning: Unable to find dynamic linker breakpoint <span class="keyword">function</span>.</span><br><span class="line">GDB will be unable to debug shared library initializers</span><br><span class="line">and track explicitly loaded dynamic code.</span><br><span class="line">Failed to <span class="built_in">read</span> a valid object file image from memory.</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">0xf7f85b59 <span class="keyword">in</span> ?? ()</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://rin777-1306176007.cos.ap-nanjing.myqcloud.com/%E6%88%AA%E5%B1%8F2021-10-27%20%E4%B8%8A%E5%8D%8811.17.59.png" alt="截屏2021-10-27 上午11.17.59"></p>
<p>​    首先需要知道这个报错的原因。</p>
<p>​    虽然我并没有查到<code>ERROR: Could not find ELF base!</code>这个报错发生的直接trigger，但是很显然这个报错发生是因为程序进程中止，因此无法找到elf base。</p>
<p>​    那么进程中止的原因何在？</p>
<h5 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h5><p>​     经过大师指点，这个问题其实是因为exp错误（</p>
<p>​    这里的问题是在断点之后，我引用了未经定义的payload，导致程序异常退出，然后这个退出反映在gdb中则是<code>elf base not found</code>。    </p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>​    如果exp正确，这个报错其实并不会存在。可以反推，如果再次碰到类似的报错，十有八九是exp的问题，而并不能把一切锅推给环境。</p>
<h2 id="3）-kernel-vsyscall？"><a href="#3）-kernel-vsyscall？" class="headerlink" title="3）__kernel_vsyscall？"></a>3）__kernel_vsyscall？</h2><h5 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h5><p>​    上一个问题中提到，如果我们只是输入gdb.attach()，那么程序会断在<code>__kernel_vsyscall</code>这个函数上。遇见这个函数也是不止一次了，但是从未想过要了解它，今天我决定一探究竟。</p>
<p>​    我们期望我们的进程暂停在puts payload之前，实际上确实，在此之前，exp没几乎没有任何与远端的io交互，所以断在奇怪的地方也可以理解，那么<code>__kernel_vsyscall</code>是一个怎样的函数，为什么偏偏就断在它的身上呢？ </p>
<h5 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h5><p>​    在stackoverflow上，我们能够看出一些端倪。</p>
<blockquote>
<p>​    <code>__kernel_vsyscal</code> is the method used by linux-gate.so (a part of the Linux kernel) to make a system call using the fastest available method, preferably the <code>sysenter</code> instruction. </p>
</blockquote>
<p>​    这其实就是个系统调用方法，回想一下在srop中的知识点，其实每个系统调用都是一个中断，然后系统切换至内核态进行工作，完成后再切换回用户态，并将结果返回至用户态。</p>
<p>​    所以出现   <code>__kernel_vsyscal</code> 意味着此刻程序正在进行系统调用。我们同时可以注意到，当  <code>__kernel_vsyscal</code> 函数执行完成，下一个函数则是<code>read</code>函数，也符合我们程序的逻辑–一个菜单题，exp中任何一条语句的结束都将使得函数执行流回到main函数，等待我们的指令。</p>
<p>当然要结束这个函数我们只需要gdb finish。</p>
<p>或者直接使用gdb.attach(sh,”break xxx”)。</p>
<p>关于系统调用我想又可以写一篇专门的博客来研究，这里就不费笔墨了，详情可见：</p>
<h2 id="4）gdb附加调试下断点的几种姿势。"><a href="#4）gdb附加调试下断点的几种姿势。" class="headerlink" title="4）gdb附加调试下断点的几种姿势。"></a>4）gdb附加调试下断点的几种姿势。</h2><h5 id="1）gdb-attach-p"><a href="#1）gdb-attach-p" class="headerlink" title="1）gdb.attach(p)"></a>1）gdb.attach(p)</h5><h5 id="2）gdb-attach-p-”break-lt-func-name-gt-”"><a href="#2）gdb-attach-p-”break-lt-func-name-gt-”" class="headerlink" title="2）gdb.attach(p,”break &lt;func name&gt;”)"></a>2）gdb.attach(p,”break &lt;func name&gt;”)</h5><h5 id="3）p-gdb-debug-“elf”-”break-lt-func-name-gt-”"><a href="#3）p-gdb-debug-“elf”-”break-lt-func-name-gt-”" class="headerlink" title="3）p = gdb.debug(“elf”,”break &lt;func name&gt;” )"></a>3）p = gdb.debug(“elf”,”break &lt;func name&gt;” )</h5><h2 id="5）p-gdb-debug-“elf”-”break-lt-func-name-gt-”"><a href="#5）p-gdb-debug-“elf”-”break-lt-func-name-gt-”" class="headerlink" title="5）p = gdb.debug(“elf”,”break &lt;func name&gt;” )"></a>5）p = gdb.debug(“elf”,”break &lt;func name&gt;” )</h2><p><img src="https://rin777-1306176007.cos.ap-nanjing.myqcloud.com/%E6%88%AA%E5%B1%8F2021-11-04%20%E4%B8%8B%E5%8D%887.35.02.png" alt="截屏2021-11-04 下午7.35.02"></p>
<p>​    </p>
<h2 id="6）Linux-Signal"><a href="#6）Linux-Signal" class="headerlink" title="6）Linux Signal"></a>6）Linux Signal</h2><p>​            在调试萌新赛题目的时候总是按ctrl+c试图终给程序一个断点，然后就报错。如图</p>
<p><img src="https://rin777-1306176007.cos.ap-nanjing.myqcloud.com/%E6%88%AA%E5%B1%8F2021-11-05%20%E4%B8%8B%E5%8D%882.46.31.png" alt="截屏2021-11-05 下午2.46.31"></p>
<p>​        感觉也不是段错误，反正类似。感觉有必要系统地了解一下linux的信号机制。</p>
<p>​        在CSAPP Chapter8 Section5中，我们能看到对于linux signal的详细解释。</p>
<p>​        signal算是对程序的一种软中断。一般我们能接收到的有关信号处理都是发生在程序异常的时候。然后这里sigint就是当我们按下ctrl+c，内核就给进程发送一个sigint信号，使进程中断。</p>
<p>​        csapp上一个表非常清晰地描述了一些信号的作用以及对应的默认行为。</p>
<p>​        <img src="https://rin777-1306176007.cos.ap-nanjing.myqcloud.com/%E6%88%AA%E5%B1%8F2021-11-05%20%E4%B8%8B%E5%8D%883.33.06.png" alt="截屏2021-11-05 下午3.33.06"></p>
<p>​            实际的信号不止这三十种。但是一般来说就是这些。</p>
<h2 id="）参考"><a href="#）参考" class="headerlink" title="）参考"></a>）参考</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/fjh1997/article/details/105434992">如何做到一边使用pwntools一边使用gdb下断点到main函数前</a></p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    <a class="pull-left" href="../pwntools%EF%BC%881%EF%BC%89--pwnlib.tube/" style="float: left;">
        ← pwntools(1)-- pwnlib.tube
    </a>
    
    
    <a class="pull-right" href="../../13/pwn%E5%9F%BA%E7%A1%80/">
        汇编小知识点 →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>

<!-- Highlight.js -->

<link rel="stylesheet"
href="//highlightjs.org/static/demo/styles/atom-one-light.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js">
</script>
<script>
hljs.initHighlightingOnLoad();

</script>

